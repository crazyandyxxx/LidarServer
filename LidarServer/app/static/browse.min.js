var checkChannels,curTaskId,curMode,curStartTime,curEndTime,startTime=moment().startOf("second").subtract(3,"days"),endTime=moment().startOf("second"),scanType="ALL",mode={LOS:"定点扫描",MOV:"走航扫描",PPI:"水平切面",RHI:"垂直切面"},srId={},rc=15e3,sa=40,snrT=2,pblT=.5;function addEvents(){document.getElementById("checkTask").addEventListener("click",checkTask),document.getElementById("importTask").addEventListener("click",ImportTask),document.getElementById("confirmExport").addEventListener("click",ExportTaskData),document.getElementById("type").addEventListener("change",selectScanType),document.getElementById("dataType").addEventListener("change",selectScanDataType)}function checkTask(){$.ajax({type:"post",data:{"start time":startTime.format("YYYY-MM-DD HH:mm:ss"),"end time":endTime.format("YYYY-MM-DD HH:mm:ss"),"scan type":scanType},url:urlBrowse,beforeSend:function(){},success:function(t){$("#task-rows").empty();var e=[];srId={};for(let a=0;a<t.result.length;a++){var r={};r.serialN=a+1,r.timespan=t.result[a].start_time+" - "+t.result[a].end_time,r.mode=mode[t.result[a].mode],r.datanum=t.result[a].data_num,e.push(r),srId[r.serialN]=t.result[a].id}$("#task-table").bootstrapTable({data:e}),$("#task-table").bootstrapTable("load",e)}})}function selectScanDataType(){"文本文件"==$("#dataType option:selected").text()?$("#collapseExample").collapse("show"):$("#collapseExample").collapse("hide")}function selectScanType(){var t=document.getElementById("type");switch(t.options[t.selectedIndex].text){case"全部":scanType="ALL";break;case"水平切面":scanType="PPI";break;case"垂直切面":scanType="RHI";break;case"定点扫描":scanType="LOS";break;case"走航扫描":scanType="MOV"}}function LinkFormatter(t,e,r){return"<a class='view' href='javascript:void(0)' onclick='ViewTask(\""+srId[e.serialN]+"\"); return false;'>查看</a>    <a class='view' href='javascript:void(0)' onclick='ExportTask(\""+srId[e.serialN]+'","'+e.mode+'","'+e.timespan+"\"); return false;'>导出</a>    <a class='view' href='javascript:void(0)' onclick='DeleteTask(\""+srId[e.serialN]+"\"); return false;'>删除</a>"}function ViewTask(t){window.open(urlBrowseTask+"?task_id="+t)}function ExportTask(t,e,r){curTaskId=t,curMode=e;let a=r.split("-");$("#dateRange").daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,startDate:a[0],endDate:a[1],minDate:a[0],maxDate:a[1],locale:{format:"YYYY/MM/DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"至",customRangeLabel:"Custom",weekLabel:"周",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},(function(t,e){curStartTime=t,curEndTime=e})),curStartTime=$("#dateRange").data("daterangepicker").startDate,curEndTime=$("#dateRange").data("daterangepicker").endDate,$("#exportModal").modal("show")}function ExportTaskData(){let t=$("#dataType option:selected").text();if(checkChannels=$("#dataChannel").val(),"文本文件"==t){if(null==checkChannels)return void alert("数据内容不能为空！");if(0==checkChannels.length)return void alert("数据内容不能为空！")}if(rc=$("#rc").val(),sa=$("#sa").val(),snrT=$("#snrT").val(),pblT=$("#pblT").val(),$("#exportModal").modal("hide"),$("#myLoading").modal("show"),"文本文件"==t)switch(curMode){case"水平切面":ExportPPI(curTaskId);break;case"垂直切面":ExportRHI(curTaskId);break;case"定点扫描":ExportLOS(curTaskId);break;case"走航扫描":ExportMOV(curTaskId)}else"数据库文件"==t&&ExportDB(curTaskId)}function DeleteTask(t){1==confirm("数据删除将不可恢复！")&&$.post(urlDeleteTask,{"task id":t},(function(t,e){checkTask()}))}function ExportDB(t){$.post(urlExportTask,{"task id":t},(function(e,r){let a=e.result[0].dataCount,n=mode[e.result[0].dataMode],s=e.result[0].startTime,l=e.result[0].endTime;for(let e=0;e<a;e+=5e3)$.post(urlExportTask,{"task id":t},(function(r,a){let o=urlExportTask+"?task_id="+t+"&data_start="+e+"&data_end="+(e+5e3),i=new XMLHttpRequest;i.onload=function(){if(200===this.status){var t=document.createElement("a");t.href=window.URL.createObjectURL(i.response),t.download=n+s+"至"+l+".ldb",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}$("#myLoading").modal("hide")},i.open("GET",o,!0),i.responseType="blob",i.send()}))}))}function WriteTypeTitle(t,e,r,a){a.str+=r.result[e].timestamp+",","ppi"==t?a.str+=r.result[e].horAngle+",":"rhi"==t?a.str+=r.result[e].verAngle+",":"mov"==t&&(a.str+=r.result[e].longitude+","+r.result[e].latitude+","+r.result[e].altitude+",")}function WrtieTypeContent(t,e,r,a){switch(e){case"ChAB":a.str+="********************\r\n",a.str+="Channel A Data\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].raw_A.join(",")+"\r\n";a.str+="********************\r\n",a.str+="Channel B Data\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].raw_B.join(",")+"\r\n";break;case"ChABPR2":a.str+="********************\r\n",a.str+="Channel A Range Correction Data\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].prr_A.join(",")+"\r\n";a.str+="********************\r\n",a.str+="Channel B Range Correction Data\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].prr_B.join(",")+"\r\n";break;case"Ext":a.str+="********************\r\n",a.str+="Aerosol Extinction\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].ext.join(",")+"\r\n";break;case"Dep":a.str+="********************\r\n",a.str+="Depolarization\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].dep.join(",")+"\r\n";break;case"PM10":a.str+="********************\r\n",a.str+="PM10\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].ext.map(t=>t>0?243*Math.pow(t,1.13):0).join(",")+"\r\n";break;case"PM25":a.str+="********************\r\n",a.str+="PM2.5\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,a),a.str+=r.result[e].ext.map(t=>t>0?121.5*Math.pow(t,1.13):0).join(",")+"\r\n";break;case"AOD":a.str+="********************\r\n",a.str+="Aerosol Optics Depth\r\n",a.str+="********************\r\n";for(let e=0;e<r.result.length;e++){WriteTypeTitle(t,e,r,a);let n=r.result[0].resolution/1e3,s=r.result[e].ext.slice(0,Math.round(3/n)).reduce((t,e)=>t+e)*n;a.str+=s>15?15:s+"\r\n"}break;case"PBL":a.str+="****************************\r\n",a.str+="Planet Boundary Layer Height\r\n",a.str+="****************************\r\n";for(let e=0;e<r.result.length;e++){WriteTypeTitle(t,e,r,a);let n=r.result[e].pbl;a.str+=n+"\r\n"}}}function ExportPPI(t){$.post(urlPPI,{"task id":t,content:"list","time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss")},(function(e,r){0==e.result.length&&($("#myLoading").modal("hide"),alert("该时段无数据！"));for(let r=0;r<e.result.length;r++)$.post(urlPPI,{"task id":t,content:"timedata",time:e.result[r].timestamp,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(t,e){$("#myLoading").modal("hide");let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n",r.str+="Vertical Angle,"+t.result[0].verAngle+"\r\n",r.str+="Horizontal Angle Start,"+t.result[0].horAngle+"\r\n",r.str+="Horizontal Angle End,"+t.result[t.result.length-1].horAngle+"\r\n",r.str+="Horizontal Angle Step,"+(t.result.length-1>0?t.result[1].horAngle-t.result[0].horAngle:0)+"\r\n";let a=[],n=[],s=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(a.push(t.result[e].longitude),n.push(t.result[e].latitude),s.push(t.result[e].altitude));a.sort((function(t,e){return t-e})),n.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),longitude=a[Math.floor(a.length/2)],latitude=n[Math.floor(a.length/2)],altitude=s[Math.floor(a.length/2)],r.str+="Longitude,"+longitude+"\r\n",r.str+="Latitude,"+latitude+"\r\n",r.str+="Altitude,"+altitude+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("ppi",checkChannels[e],t,r);var l=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(l,"水平切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(l);o.setAttribute("href",i),o.setAttribute("download","水平切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportRHI(t){$.post(urlRHI,{"task id":t,content:"list","time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss")},(function(e,r){0==e.result.length&&($("#myLoading").modal("hide"),alert("该时段无数据！"));for(let r=0;r<e.result.length;r++)$.post(urlRHI,{"task id":t,content:"timedata",time:e.result[r].timestamp,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(t,e){$("#myLoading").modal("hide");let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n",r.str+="Horizontal Angle,"+t.result[0].horAngle+"\r\n",r.str+="Vertical Angle Start,"+t.result[0].verAngle+"\r\n",r.str+="Vertical Angle End,"+t.result[t.result.length-1].verAngle+"\r\n",r.str+="Vertical Angle Step,"+(t.result.length-1>0?t.result[1].verAngle-t.result[0].verAngle:0)+"\r\n";let a=[],n=[],s=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(a.push(t.result[e].longitude),n.push(t.result[e].latitude),s.push(t.result[e].altitude));a.sort((function(t,e){return t-e})),n.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),longitude=a[Math.floor(a.length/2)],latitude=n[Math.floor(a.length/2)],altitude=s[Math.floor(a.length/2)],r.str+="Longitude,"+longitude+"\r\n",r.str+="Latitude,"+latitude+"\r\n",r.str+="Altitude,"+altitude+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("rhi",checkChannels[e],t,r);var l=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(l,"垂直切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(l);o.setAttribute("href",i),o.setAttribute("download","垂直切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportLOS(t){$.post(urlLOS,{"task id":t,content:"total count","time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss"),"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(e,r){let a=e.result[0];for(let e=0;e<a;e+=1e3)$.post(urlLOS,{"task id":t,content:"export","data start":e,"data end":e+1e3,"time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss"),"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(t,e){$("#myLoading").modal("hide");let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("los",checkChannels[e],t,r);var a=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"定点扫描_"+t.result[0].timestamp+".csv");else{var n=document.createElement("a");if(void 0!==n.download){var s=URL.createObjectURL(a);n.setAttribute("href",s),n.setAttribute("download","定点扫描_"+t.result[0].timestamp+".csv"),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}}))}))}function ExportMOV(t){$.post(urlMOV,{"task id":t,content:"total count","time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss"),"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(e,r){let a=e.result[0];for(let e=0;e<a;e+=1e3)$.post(urlMOV,{"task id":t,content:"export","data start":e,"data end":e+1e3,"time start":curStartTime.format("YYYY-MM-DD HH:mm:ss"),"time end":curEndTime.format("YYYY-MM-DD HH:mm:ss"),"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(t,e){$("#myLoading").modal("hide");let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("mov",checkChannels[e],t,r);var a=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"走航扫描_"+t.result[0].timestamp+".csv");else{var n=document.createElement("a");if(void 0!==n.download){var s=URL.createObjectURL(a);n.setAttribute("href",s),n.setAttribute("download","走航扫描_"+t.result[0].timestamp+".csv"),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}}))}))}function ImportTask(){var t=document.createElement("input");t.type="file",t.accept=".ldb",t.style.visibility="hidden",t.onchange=function(t){$("#myLoading").modal("show");let e=t.target.files[0],r=new FormData;r.append("task_file",e),fetch(urlImportTask,{method:"POST",body:r}).then((function(t){$("#myLoading").modal("hide"),checkTask()}))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}$((function(){$('input[name="datetimes"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,startDate:startTime,endDate:endTime,locale:{format:"YYYY/MM/DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"至",customRangeLabel:"Custom",weekLabel:"周",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},(function(t,e){startTime=t,endTime=e})),addEvents(),$("#dataChannel").multiselect(),$("#collapseExample").collapse({toggle:!0})}));

var startTime=moment().startOf("second").subtract(3,"days"),endTime=moment().startOf("second"),scanType="ALL";$((function(){$('input[name="datetimes"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,startDate:startTime,endDate:endTime,locale:{format:"YYYY/MM/DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"至",customRangeLabel:"Custom",weekLabel:"周",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},(function(t,e){startTime=t,endTime=e}))}));var mode={LOS:"定点扫描",MOV:"走航扫描",PPI:"水平切面",RHI:"垂直切面"},srId={};function checkTask(){var t=$("#task-rows");$.post(urlBrowse,{"start time":startTime.format("YYYY-MM-DD HH:mm:ss"),"end time":endTime.format("YYYY-MM-DD HH:mm:ss"),"scan type":scanType},(function(e,n){if(t.empty(),"success"==n){var r=[];srId={};for(let t=0;t<e.result.length;t++){var l={};l.serialN=t+1,l.timespan=e.result[t].start_time+" - "+e.result[t].end_time,l.mode=mode[e.result[t].mode],l.datanum=e.result[t].data_num,r.push(l),srId[l.serialN]=e.result[t].id}$("#task-table").bootstrapTable({data:r}),$("#task-table").bootstrapTable("load",r)}}))}function selectScanType(){var t=document.getElementById("type");switch(t.options[t.selectedIndex].text){case"全部":scanType="ALL";break;case"水平切面":scanType="PPI";break;case"垂直切面":scanType="RHI";break;case"定点扫描":scanType="LOS";break;case"走航扫描":scanType="MOV"}}function LinkFormatter(t,e,n){return"<a class='view' href='javascript:void(0)' onclick='ViewTask(\""+srId[e.serialN]+"\"); return false;'>查看</a>    <a class='view' href='javascript:void(0)' onclick='ExportTask(\""+srId[e.serialN]+'","'+e.mode+"\"); return false;'>导出</a>    <a class='view' href='javascript:void(0)' onclick='DeleteTask(\""+srId[e.serialN]+"\"); return false;'>删除</a>"}function ViewTask(t){window.open(urlBrowseTask+"?task_id="+t)}function ExportTask(t,e){var n=document.getElementById("txt"),r=document.getElementById("db");n.checked=!1,r.checked=!1;var l=document.getElementById("myModal"),s=document.getElementsByClassName("close")[0],a=document.getElementById("myLoading");l.style.display="block",s.onclick=function(){l.style.display="none"},n.onclick=function(){switch(l.style.display="none",a.style.display="block",e){case"水平切面":ExportPPI(t);break;case"垂直切面":ExportRHI(t);break;case"定点扫描":ExportLOS(t);break;case"走航扫描":ExportMOV(t)}},r.onclick=function(){l.style.display="none",a.style.display="block",ExportDB(t)}}function DeleteTask(t){1==confirm("数据删除将不可恢复！")&&$.post(urlDeleteTask,{"task id":t},(function(t,e){checkTask()}))}function ExportDB(t){$.post(urlExportTask,{"task id":t},(function(e,n){let r=e.result[0].dataCount,l=mode[e.result[0].dataMode],s=e.result[0].startTime,a=e.result[0].endTime;for(let e=0;e<r;e+=5e3)$.post(urlExportTask,{"task id":t},(function(n,r){let o=urlExportTask+"?task_id="+t+"&data_start="+e+"&data_end="+(e+5e3),i=new XMLHttpRequest;i.onload=function(){if(200===this.status){var t=document.createElement("a");t.href=window.URL.createObjectURL(i.response),t.download=l+s+"至"+a+".ldb",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}document.getElementById("myLoading").style.display="none"},i.open("GET",o,!0),i.responseType="blob",i.send()}))}))}function ExportPPI(t){$.post(urlPPI,{"task id":t,content:"list"},(function(e,n){for(let n=0;n<e.result.length;n++)$.post(urlPPI,{"task id":t,content:"timedata",time:e.result[n].timestamp},(function(t,e){document.getElementById("myLoading").style.display="none";let n="";n+="Data Count,"+t.result.length+"\r\n",n+="Data Length,"+t.result[0].raw_A.length+"\r\n",n+="Resolution,"+t.result[0].resolution+"\r\n",n+="Vertical Angle,"+t.result[0].verAngle+"\r\n",n+="Horizontal Angle Start,"+t.result[0].horAngle+"\r\n",n+="Horizontal Angle End,"+t.result[t.result.length-1].horAngle+"\r\n",n+="Horizontal Angle Step,"+(t.result[1].horAngle-t.result[0].horAngle)+"\r\n";let r=[],l=[],s=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(r.push(t.result[e].longitude),l.push(t.result[e].latitude),s.push(t.result[e].altitude));r.sort((function(t,e){return t-e})),l.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),longitude=r[Math.floor(r.length/2)],latitude=l[Math.floor(r.length/2)],altitude=s[Math.floor(r.length/2)],n+="Longitude,"+longitude+"\r\n",n+="Latitude,"+latitude+"\r\n",n+="Altitude,"+altitude+"\r\n",n+="********************\r\n",n+="Aerosol Extinction\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].horAngle+",",n+=t.result[e].ext.join(",")+"\r\n";n+="********************\r\n",n+="Depolarization\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].horAngle+",",n+=t.result[e].dep.join(",")+"\r\n";n+="********************\r\n",n+="Channel A Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].horAngle+",",n+=t.result[e].raw_A.join(",")+"\r\n";n+="********************\r\n",n+="Channel B Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].horAngle+",",n+=t.result[e].raw_B.join(",")+"\r\n";var a=new Blob([n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"水平切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(a);o.setAttribute("href",i),o.setAttribute("download","水平切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportRHI(t){$.post(urlRHI,{"task id":t,content:"list"},(function(e,n){for(let n=0;n<e.result.length;n++)$.post(urlRHI,{"task id":t,content:"timedata",time:e.result[n].timestamp},(function(t,e){document.getElementById("myLoading").style.display="none";let n="";n+="Data Count,"+t.result.length+"\r\n",n+="Data Length,"+t.result[0].raw_A.length+"\r\n",n+="Resolution,"+t.result[0].resolution+"\r\n",n+="Horizontal Angle,"+t.result[0].horAngle+"\r\n",n+="Vertical Angle Start,"+t.result[0].verAngle+"\r\n",n+="Vertical Angle End,"+t.result[t.result.length-1].verAngle+"\r\n",n+="Vertical Angle Step,"+(t.result[1].verAngle-t.result[0].verAngle)+"\r\n";let r=[],l=[],s=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(r.push(t.result[e].longitude),l.push(t.result[e].latitude),s.push(t.result[e].altitude));r.sort((function(t,e){return t-e})),l.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),longitude=r[Math.floor(r.length/2)],latitude=l[Math.floor(r.length/2)],altitude=s[Math.floor(r.length/2)],n+="Longitude,"+longitude+"\r\n",n+="Latitude,"+latitude+"\r\n",n+="Altitude,"+altitude+"\r\n",n+="********************\r\n",n+="Aerosol Extinction\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].verAngle+",",n+=t.result[e].ext.join(",")+"\r\n";n+="********************\r\n",n+="Depolarization\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].verAngle+",",n+=t.result[e].dep.join(",")+"\r\n";n+="********************\r\n",n+="Channel A Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].verAngle+",",n+=t.result[e].raw_A.join(",")+"\r\n";n+="********************\r\n",n+="Channel B Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].verAngle+",",n+=t.result[e].raw_B.join(",")+"\r\n";var a=new Blob([n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"垂直切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(a);o.setAttribute("href",i),o.setAttribute("download","垂直切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportLOS(t){$.post(urlLOS,{"task id":t,content:"total count"},(function(e,n){let r=e.result[0];for(let e=0;e<r;e+=1e3)$.post(urlLOS,{"task id":t,content:"export","data start":e,"data end":e+1e3},(function(t,e){document.getElementById("myLoading").style.display="none";let n="";n+="Data Count,"+t.result.length+"\r\n",n+="Data Length,"+t.result[0].raw_A.length+"\r\n",n+="Resolution,"+t.result[0].resolution+"\r\n",n+="********************\r\n",n+="Aerosol Extinction\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+",",n+=t.result[e].ext.join(",")+"\r\n";n+="********************\r\n",n+="Depolarization\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+",",n+=t.result[e].dep.join(",")+"\r\n";n+="********************\r\n",n+="Channel A Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+",",n+=t.result[e].raw_A.join(",")+"\r\n";n+="********************\r\n",n+="Channel B Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+",",n+=t.result[e].raw_B.join(",")+"\r\n";var r=new Blob([n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(r,"定点扫描_"+t.result[0].timestamp+".csv");else{var l=document.createElement("a");if(void 0!==l.download){var s=URL.createObjectURL(r);l.setAttribute("href",s),l.setAttribute("download","定点扫描_"+t.result[0].timestamp+".csv"),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}}}))}))}function ExportMOV(t){$.post(urlMOV,{"task id":t,content:"total count"},(function(e,n){let r=e.result[0];for(let e=0;e<r;e+=1e3)$.post(urlMOV,{"task id":t,content:"export","data start":e,"data end":e+1e3},(function(t,e){document.getElementById("myLoading").style.display="none";let n="";n+="Data Count,"+t.result.length+"\r\n",n+="Data Length,"+t.result[0].raw_A.length+"\r\n",n+="Resolution,"+t.result[0].resolution+"\r\n",n+="********************\r\n",n+="Aerosol Extinction\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].longitude+","+t.result[e].latitude+","+t.result[e].altitude+",",n+=t.result[e].ext.join(",")+"\r\n";n+="********************\r\n",n+="Depolarization\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].longitude+","+t.result[e].latitude+","+t.result[e].altitude+",",n+=t.result[e].dep.join(",")+"\r\n";n+="********************\r\n",n+="Channel A Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].longitude+","+t.result[e].latitude+","+t.result[e].altitude+",",n+=t.result[e].raw_A.join(",")+"\r\n";n+="********************\r\n",n+="Channel B Data\r\n",n+="********************\r\n";for(let e=0;e<t.result.length;e++)n+=t.result[e].timestamp+","+t.result[e].longitude+","+t.result[e].latitude+","+t.result[e].altitude+",",n+=t.result[e].raw_B.join(",")+"\r\n";var r=new Blob([n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(r,"走航扫描_"+t.result[0].timestamp+".csv");else{var l=document.createElement("a");if(void 0!==l.download){var s=URL.createObjectURL(r);l.setAttribute("href",s),l.setAttribute("download","走航扫描_"+t.result[0].timestamp+".csv"),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}}}))}))}function ImportTask(){var t=document.createElement("input");t.type="file",t.accept=".ldb",t.style.visibility="hidden",t.onchange=function(t){document.getElementById("myLoading").style.display="block";let e=t.target.files[0],n=new FormData;n.append("task_file",e),fetch(urlImportTask,{method:"POST",body:n}).then((function(t){checkTask(),document.getElementById("myLoading").style.display="none"}))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}

var startTime=moment().startOf("second").subtract(3,"days"),endTime=moment().startOf("second"),scanType="ALL";$((function(){$('input[name="datetimes"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,startDate:startTime,endDate:endTime,locale:{format:"YYYY/MM/DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"至",customRangeLabel:"Custom",weekLabel:"周",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},(function(t,e){startTime=t,endTime=e}))}));var checkChannels,mode={LOS:"定点扫描",MOV:"走航扫描",PPI:"水平切面",RHI:"垂直切面"},srId={};function checkTask(){var t=$("#task-rows");$.post(urlBrowse,{"start time":startTime.format("YYYY-MM-DD HH:mm:ss"),"end time":endTime.format("YYYY-MM-DD HH:mm:ss"),"scan type":scanType},(function(e,r){if(t.empty(),"success"==r){var n=[];srId={};for(let t=0;t<e.result.length;t++){var s={};s.serialN=t+1,s.timespan=e.result[t].start_time+" - "+e.result[t].end_time,s.mode=mode[e.result[t].mode],s.datanum=e.result[t].data_num,n.push(s),srId[s.serialN]=e.result[t].id}$("#task-table").bootstrapTable({data:n}),$("#task-table").bootstrapTable("load",n)}}))}function selectScanType(){var t=document.getElementById("type");switch(t.options[t.selectedIndex].text){case"全部":scanType="ALL";break;case"水平切面":scanType="PPI";break;case"垂直切面":scanType="RHI";break;case"定点扫描":scanType="LOS";break;case"走航扫描":scanType="MOV"}}function LinkFormatter(t,e,r){return"<a class='view' href='javascript:void(0)' onclick='ViewTask(\""+srId[e.serialN]+"\"); return false;'>查看</a>    <a class='view' href='javascript:void(0)' onclick='ExportTask(\""+srId[e.serialN]+'","'+e.mode+"\"); return false;'>导出</a>    <a class='view' href='javascript:void(0)' onclick='DeleteTask(\""+srId[e.serialN]+"\"); return false;'>删除</a>"}function ViewTask(t){window.open(urlBrowseTask+"?task_id="+t)}function ExportTask(t,e){var r=document.getElementById("txt"),n=document.getElementById("db"),s=document.getElementById("confirm"),l=document.getElementById("dataKind");r.checked=!1,n.checked=!1;var a=document.getElementById("myModal"),o=document.getElementsByClassName("close")[0],i=document.getElementById("myLoading");l.style.display="none",a.style.display="block",o.onclick=function(){a.style.display="none"},s.onclick=function(){if(a.style.display="none",checkChannels=document.querySelectorAll('input[name="rkind"]:checked'),r.checked)switch(i.style.display="block",e){case"水平切面":ExportPPI(t);break;case"垂直切面":ExportRHI(t);break;case"定点扫描":ExportLOS(t);break;case"走航扫描":ExportMOV(t)}else n.checked&&(i.style.display="block",ExportDB(t))},r.onclick=function(){l.style.display="block"},n.onclick=function(){l.style.display="none"}}function DeleteTask(t){1==confirm("数据删除将不可恢复！")&&$.post(urlDeleteTask,{"task id":t},(function(t,e){checkTask()}))}function ExportDB(t){$.post(urlExportTask,{"task id":t},(function(e,r){let n=e.result[0].dataCount,s=mode[e.result[0].dataMode],l=e.result[0].startTime,a=e.result[0].endTime;for(let e=0;e<n;e+=5e3)$.post(urlExportTask,{"task id":t},(function(r,n){let o=urlExportTask+"?task_id="+t+"&data_start="+e+"&data_end="+(e+5e3),i=new XMLHttpRequest;i.onload=function(){if(200===this.status){var t=document.createElement("a");t.href=window.URL.createObjectURL(i.response),t.download=s+l+"至"+a+".ldb",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}document.getElementById("myLoading").style.display="none"},i.open("GET",o,!0),i.responseType="blob",i.send()}))}))}function WriteTypeTitle(t,e,r,n){n.str+=r.result[e].timestamp+",","ppi"==t?n.str+=r.result[e].horAngle+",":"rhi"==t?n.str+=r.result[e].verAngle+",":"mov"==t&&(n.str+=r.result[e].longitude+","+r.result[e].latitude+","+r.result[e].altitude+",")}function WrtieTypeContent(t,e,r,n){switch(e){case"ChAB":n.str+="********************\r\n",n.str+="Channel A Data\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].raw_A.join(",")+"\r\n";n.str+="********************\r\n",n.str+="Channel B Data\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].raw_B.join(",")+"\r\n";break;case"ChABPR2":n.str+="********************\r\n",n.str+="Channel A Range Correction Data\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].prr_A.join(",")+"\r\n";n.str+="********************\r\n",n.str+="Channel B Range Correction Data\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].prr_B.join(",")+"\r\n";break;case"Ext":n.str+="********************\r\n",n.str+="Aerosol Extinction\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].ext.join(",")+"\r\n";break;case"Dep":n.str+="********************\r\n",n.str+="Depolarization\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].dep.join(",")+"\r\n";break;case"PM10":n.str+="********************\r\n",n.str+="PM10\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].ext.map(t=>t>0?243*Math.pow(t,1.13):0).join(",")+"\r\n";break;case"PM25":n.str+="********************\r\n",n.str+="PM2.5\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++)WriteTypeTitle(t,e,r,n),n.str+=r.result[e].ext.map(t=>t>0?121.5*Math.pow(t,1.13):0).join(",")+"\r\n";break;case"AOD":n.str+="********************\r\n",n.str+="Aerosol Optics Depth\r\n",n.str+="********************\r\n";for(let e=0;e<r.result.length;e++){WriteTypeTitle(t,e,r,n);let s=r.result[0].resolution/1e3,l=r.result[e].ext.slice(0,Math.round(3/s)).reduce((t,e)=>t+e)*s;n.str+=l>15?15:l+"\r\n"}}}function ExportPPI(t){$.post(urlPPI,{"task id":t,content:"list"},(function(e,r){for(let r=0;r<e.result.length;r++)$.post(urlPPI,{"task id":t,content:"timedata",time:e.result[r].timestamp},(function(t,e){document.getElementById("myLoading").style.display="none";let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n",r.str+="Vertical Angle,"+t.result[0].verAngle+"\r\n",r.str+="Horizontal Angle Start,"+t.result[0].horAngle+"\r\n",r.str+="Horizontal Angle End,"+t.result[t.result.length-1].horAngle+"\r\n",r.str+="Horizontal Angle Step,"+(t.result.length-1>0?t.result[1].horAngle-t.result[0].horAngle:0)+"\r\n";let n=[],s=[],l=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(n.push(t.result[e].longitude),s.push(t.result[e].latitude),l.push(t.result[e].altitude));n.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),l.sort((function(t,e){return t-e})),longitude=n[Math.floor(n.length/2)],latitude=s[Math.floor(n.length/2)],altitude=l[Math.floor(n.length/2)],r.str+="Longitude,"+longitude+"\r\n",r.str+="Latitude,"+latitude+"\r\n",r.str+="Altitude,"+altitude+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("ppi",checkChannels[e].value,t,r);var a=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"水平切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(a);o.setAttribute("href",i),o.setAttribute("download","水平切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportRHI(t){$.post(urlRHI,{"task id":t,content:"list"},(function(e,r){for(let r=0;r<e.result.length;r++)$.post(urlRHI,{"task id":t,content:"timedata",time:e.result[r].timestamp},(function(t,e){document.getElementById("myLoading").style.display="none";let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n",r.str+="Horizontal Angle,"+t.result[0].horAngle+"\r\n",r.str+="Vertical Angle Start,"+t.result[0].verAngle+"\r\n",r.str+="Vertical Angle End,"+t.result[t.result.length-1].verAngle+"\r\n",r.str+="Vertical Angle Step,"+(t.result.length-1>0?t.result[1].verAngle-t.result[0].verAngle:0)+"\r\n";let n=[],s=[],l=[];for(let e=0;e<t.result.length;e++)t.result[e].longitude>0&&(n.push(t.result[e].longitude),s.push(t.result[e].latitude),l.push(t.result[e].altitude));n.sort((function(t,e){return t-e})),s.sort((function(t,e){return t-e})),l.sort((function(t,e){return t-e})),longitude=n[Math.floor(n.length/2)],latitude=s[Math.floor(n.length/2)],altitude=l[Math.floor(n.length/2)],r.str+="Longitude,"+longitude+"\r\n",r.str+="Latitude,"+latitude+"\r\n",r.str+="Altitude,"+altitude+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("rhi",checkChannels[e].value,t,r);var a=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"垂直切面_"+t.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(a);o.setAttribute("href",i),o.setAttribute("download","垂直切面_"+t.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ExportLOS(t){$.post(urlLOS,{"task id":t,content:"total count"},(function(e,r){let n=e.result[0];for(let e=0;e<n;e+=1e3)$.post(urlLOS,{"task id":t,content:"export","data start":e,"data end":e+1e3},(function(t,e){document.getElementById("myLoading").style.display="none";let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("los",checkChannels[e].value,t,r);var n=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(n,"定点扫描_"+t.result[0].timestamp+".csv");else{var s=document.createElement("a");if(void 0!==s.download){var l=URL.createObjectURL(n);s.setAttribute("href",l),s.setAttribute("download","定点扫描_"+t.result[0].timestamp+".csv"),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}}))}))}function ExportMOV(t){$.post(urlMOV,{"task id":t,content:"total count"},(function(e,r){let n=e.result[0];for(let e=0;e<n;e+=1e3)$.post(urlMOV,{"task id":t,content:"export","data start":e,"data end":e+1e3},(function(t,e){document.getElementById("myLoading").style.display="none";let r={str:""};r.str+="Data Count,"+t.result.length+"\r\n",r.str+="Data Length,"+t.result[0].raw_A.length+"\r\n",r.str+="Resolution,"+t.result[0].resolution+"\r\n";for(let e=0;e<checkChannels.length;e++)WrtieTypeContent("mov",checkChannels[e].value,t,r);var n=new Blob([r.str],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(n,"走航扫描_"+t.result[0].timestamp+".csv");else{var s=document.createElement("a");if(void 0!==s.download){var l=URL.createObjectURL(n);s.setAttribute("href",l),s.setAttribute("download","走航扫描_"+t.result[0].timestamp+".csv"),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}}))}))}function ImportTask(){var t=document.createElement("input");t.type="file",t.accept=".ldb",t.style.visibility="hidden",t.onchange=function(t){document.getElementById("myLoading").style.display="block";let e=t.target.files[0],r=new FormData;r.append("task_file",e),fetch(urlImportTask,{method:"POST",body:r}).then((function(t){checkTask(),document.getElementById("myLoading").style.display="none"}))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}

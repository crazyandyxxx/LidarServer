var startTime=moment().startOf("second").subtract(3,"days"),endTime=moment().startOf("second"),scanType="ALL";$((function(){$('input[name="datetimes"]').daterangepicker({timePicker:!0,timePicker24Hour:!0,timePickerSeconds:!0,startDate:startTime,endDate:endTime,locale:{format:"YYYY/MM/DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"至",customRangeLabel:"Custom",weekLabel:"周",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1}},(function(e,t){startTime=e,endTime=t}))}));var mode={LOS:"定点扫描",MOV:"走航扫描",PPI:"水平切面",RHI:"垂直切面"},srId={};function checkTask(){var e=$("#task-rows");$.post(urlBrowse,{"start time":startTime.format("YYYY-MM-DD HH:mm:ss"),"end time":endTime.format("YYYY-MM-DD HH:mm:ss"),"scan type":scanType},(function(t,n){if(e.empty(),"success"==n){var r=[];srId={};for(let e=0;e<t.result.length;e++){var a={};a.serialN=e+1,a.timespan=t.result[e].start_time+" - "+t.result[e].end_time,a.mode=mode[t.result[e].mode],a.datanum=t.result[e].data_num,r.push(a),srId[a.serialN]=t.result[e].id}$("#task-table").bootstrapTable({data:r}),$("#task-table").bootstrapTable("load",r)}}))}function selectScanType(){var e=document.getElementById("type");switch(e.options[e.selectedIndex].text){case"全部":scanType="ALL";break;case"水平切面":scanType="PPI";break;case"垂直切面":scanType="RHI";break;case"定点扫描":scanType="LOS";break;case"走航扫描":scanType="MOV"}}function LinkFormatter(e,t,n){return"<a class='view' href='javascript:void(0)' onclick='ViewTask(\""+srId[t.serialN]+"\"); return false;'>查看</a>    <a class='view' href='javascript:void(0)' onclick='ExportTask(\""+srId[t.serialN]+'","'+t.mode+"\"); return false;'>导出</a>    <a class='view' href='javascript:void(0)' onclick='DeleteTask(\""+srId[t.serialN]+"\"); return false;'>删除</a>"}function ViewTask(e){window.open(urlBrowseTask+"?task_id="+e)}function ExportTask(e,t){var n=document.getElementById("txt"),r=document.getElementById("db");n.checked=!1,r.checked=!1;var a=document.getElementById("myModal"),s=document.getElementsByClassName("close")[0];a.style.display="block",s.onclick=function(){a.style.display="none"},n.onclick=function(){switch(a.style.display="none",t){case"水平切面":ExportPPI(e)}},r.onclick=function(){a.style.display="none",ExportDB(e)}}function DeleteTask(e){1==confirm("数据删除将不可恢复！")&&$.post(urlDeleteTask,{"task id":e},(function(e,t){checkTask()}))}function ExportDB(e){$.post(urlExportTask,{"task id":e},(function(t,n){let r=t.result[0];for(let t=0;t<r;t+=5e3)$.post(urlExportTask,{"task id":e},(function(n,r){var a=urlExportTask+"?task_id="+e+"&data_start="+t+"&data_end="+(t+5e3),s=new XMLHttpRequest;s.onload=function(){if(200===this.status){var e=document.createElement("a");e.href=window.URL.createObjectURL(s.response),e.download="export.ldb",e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}},s.open("GET",a,!0),s.responseType="blob",s.send()}))}))}function ExportPPI(e){$.post(urlPPI,{"task id":e,content:"list"},(function(t,n){for(let n=0;n<t.result.length;n++)$.post(urlPPI,{"task id":e,content:"timedata",time:t.result[n].timestamp},(function(e,t){let n="";n+="Data Count,"+e.result.length+"\r\n",n+="Data Length,"+e.result[0].raw_A.length+"\r\n",n+="Resolution,"+e.result[0].resolution+"\r\n",n+="Vertical Angle,"+e.result[0].verAngle+"\r\n",n+="Horizontal Angle Start,"+e.result[0].horAngle+"\r\n",n+="Horizontal Angle End,"+e.result[e.result.length-1].horAngle+"\r\n",n+="Horizontal Angle Step,"+(e.result[1].horAngle-e.result[0].horAngle)+"\r\n";let r=[],a=[],s=[];for(let t=0;t<e.result.length;t++)e.result[t].longitude>0&&(r.push(e.result[t].longitude),a.push(e.result[t].latitude),s.push(e.result[t].altitude));r.sort((function(e,t){return e-t})),a.sort((function(e,t){return e-t})),s.sort((function(e,t){return e-t})),longitude=r[Math.floor(r.length/2)],latitude=a[Math.floor(r.length/2)],altitude=s[Math.floor(r.length/2)],n+="Longitude,"+longitude+"\r\n",n+="Latitude,"+latitude+"\r\n",n+="Altitude,"+altitude+"\r\n",n+="********************\r\n",n+="Aerosol Extinction\r\n",n+="********************\r\n";for(let t=0;t<e.result.length;t++)n+=e.result[t].timestamp+","+e.result[t].horAngle+",",n+=e.result[t].ext.join(",")+"\r\n";n+="********************\r\n",n+="Depolarization\r\n",n+="********************\r\n";for(let t=0;t<e.result.length;t++)n+=e.result[t].timestamp+","+e.result[t].horAngle+",",n+=e.result[t].dep.join(",")+"\r\n";n+="********************\r\n",n+="Channel A Data\r\n",n+="********************\r\n";for(let t=0;t<e.result.length;t++)n+=e.result[t].timestamp+","+e.result[t].horAngle+",",n+=e.result[t].raw_A.join(",")+"\r\n";n+="********************\r\n",n+="Channel B Data\r\n",n+="********************\r\n";for(let t=0;t<e.result.length;t++)n+=e.result[t].timestamp+","+e.result[t].horAngle+",",n+=e.result[t].raw_B.join(",")+"\r\n";var l=new Blob([n],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(l,"水平切面_"+e.result[0].timestamp+".csv");else{var o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(l);o.setAttribute("href",i),o.setAttribute("download","水平切面_"+e.result[0].timestamp+".csv"),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}}))}))}function ImportTask(){var e=document.createElement("input");e.type="file",e.accept=".ldb",e.style.visibility="hidden",e.onchange=function(e){document.getElementById("importWaiting").style.visibility="visible";let t=e.target.files[0],n=new FormData;n.append("task_file",t),fetch(urlImportTask,{method:"POST",body:n}).then((function(e){checkTask(),document.getElementById("importWaiting").style.visibility="hidden"}))},document.body.appendChild(e),e.click(),document.body.removeChild(e)}

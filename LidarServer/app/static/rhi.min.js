function drawColorbar(e){var t=document.getElementById("canvas");width=t.width,height=t.height;var a=t.getContext("2d"),r=a.createLinearGradient(0,10,0,250);for(let t=0;t<e;t++){var n=getColor(t/(e-1),0,1,1),o="rgb("+Math.floor(255*n.r)+","+Math.floor(255*n.g)+","+Math.floor(255*n.b)+")";r.addColorStop(1-t/(e-1),o)}a.fillStyle=r,a.fillRect(0,10,10,240)}var tickColor="black",textColor="black";function drawTicks(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(10,0,e.width,e.height),t.strokeStyle=tickColor;for(let e=0;e<6;e++)t.beginPath(),t.moveTo(10,10+48*e),t.lineTo(15,10+48*e),t.stroke()}function drawTickText(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(16,0,e.width,e.height);let a=(vMax-vMin)/5;t.fillStyle=textColor;for(let e=0;e<6;e++)t.fillText((vMax-e*a).toExponential(1),16,10+48*e)}var map,object3Dlayer,vMax=1e4,vMin=0;window.onload=function(){drawColorbar(11),drawTicks(),drawTickText(),map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:16,pitch:60,center:[116.396132,39.900444]}),object3Dlayer=new AMap.Object3DLayer,map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var t=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite},{id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(t),map.setLayers(t.getEnabledLayers()),t.on("layerPropChanged",(function(e){e.props.enable&&(e.layer.id.includes("satellite")?(tickColor="#FFF",textColor="#FFF",drawTicks(),drawTickText()):e.layer.id.includes("tile")&&(tickColor="#000",textColor="#000",drawTicks(),drawTickText()))}))})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)})),$.post(urlGetRhiData,{"task id":task_id,content:"list"},(function(e,t){var a=document.getElementById("timeSeries");a.addEventListener("change",SelectTime),document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity);for(let t=0;t<e.result.length;t++)a.options.add(new Option(e.result[t].timestamp+""));$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:a.options[0].text},url:urlGetRhiData,beforeSend:function(){document.getElementById("myLoading").style.display="block"},success:function(e){document.getElementById("myLoading").style.display="none",prepareData(e),drawData=rdata.prr_A,createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),map.setCenter(position),map.setFitView(),horAng=e.result[0].horAngle,verAngStart=e.result[0].verAngle,verAngEnd=e.result[e.result.length-1].verAngle,verAngStep=e.result[1].verAngle-e.result[0].verAngle,document.getElementById("angleRange").textContent="扫描范围"+verAngStart+" - "+verAngEnd,document.getElementById("angleStep").textContent="扫描步长"+verAngStep,document.getElementById("angleHor").textContent="方位角"+horAng,document.getElementById("timeStamp").textContent=a.options[0].text+"至"+e.result[e.result.length-1].timestamp}})}))};var rdata={},rangeMax=6e3,colorOpacity=(vMax=1e4,vMin=0,.5),resolution=15,horAng=0,verAngStart=0,verAngEnd=360,verAngStep=5,longitude=0,latitude=0,altitude=0,drawData=[],position=new AMap.LngLat(0,0);function createPie(e,t,a,r,n,o,l,i,s,d,c){for(var g=Math.floor((l-o)/i),u=0;u<g;u++){var h=generateTriangle(e,r,a,u,t,n,o+u*i,o+(u+1)*i,s,d,c);object3Dlayer.add(h)}}function generateTriangle(e,t,a,r,n,o,l,i,s,d,c){var g=map.lngLatToGeodeticCoord(e),u=(map.lngLatToGeodeticCoord(e.offset(5e3,0)).x-g.x)/5e3,h=g.x,p=g.y,v=[],M=[],m=[],y=[],A=[],x=[],w=t/a;a*=u;var f=l>90?o+180:o,C=i>90?o+180:o;l=l>90?180-l:l,i=i>90?180-i:i;for(var I=0;I<w+1;I++)v.push(h+I*a*Math.cos(l/180*Math.PI)*Math.sin(f/180*Math.PI)),M.push(p-I*a*Math.cos(l/180*Math.PI)*Math.cos(f/180*Math.PI)),m.push(0-I*a*Math.sin(l/180*Math.PI)),y.push(h+I*a*Math.cos(i/180*Math.PI)*Math.sin(C/180*Math.PI)),A.push(p-I*a*Math.cos(i/180*Math.PI)*Math.cos(C/180*Math.PI)),x.push(0-I*a*Math.sin(i/180*Math.PI));var b=new AMap.Object3D.Mesh;b.transparent=!0,b.backOrFront="both";var E=b.geometry;for(I=0;I<w;I++){E.vertices.push(v[I],M[I],m[I]),E.vertices.push(v[I+1],M[I+1],m[I+1]),E.vertices.push(y[I+1],A[I+1],x[I+1]),E.vertices.push(v[I],M[I],m[I]),E.vertices.push(y[I],A[I],x[I]),E.vertices.push(y[I+1],A[I+1],x[I+1]);var S=getColor(n[r][I],s,d,c),B=getColor(n[r][I+1],s,d,c),D=getColor(n[r+1][I],s,d,c),T=getColor(n[r+1][I+1],s,d,c);E.vertexColors.push(S.r,S.g,S.b,S.a),E.vertexColors.push(B.r,B.g,B.b,B.a),E.vertexColors.push(T.r,T.g,T.b,T.a),E.vertexColors.push(S.r,S.g,S.b,S.a),E.vertexColors.push(D.r,D.g,D.b,D.a),E.vertexColors.push(T.r,T.g,T.b,T.a)}return b}function getColor(e,t,a,r){var n={};e<t&&(e=t),e>a&&(e=a);var o=a-t;if(n.a=r-.1+.2*(e-t)/o,e<t+.25*o){var l=4*(e-t)/o;n.r=0,n.g=l,n.b=1}else if(e<t+.5*o){var i=1+4*(t+.25*o-e)/o;n.r=0,n.g=1,n.b=i}else if(e<t+.75*o){var s=4*(e-t-.5*o)/o;n.r=s,n.g=1,n.b=0}else{l=1+4*(t+.75*o-e)/o;n.r=1,n.g=l,n.b=0}return n}function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pm10=[],rdata.pm25=[],resolution=e.result[0].resolution,horAng=e.result[0].horAngle,verAngStart=e.result[0].verAngle,verAngEnd=e.result[e.result.length-1].verAngle,verAngStep=e.result[1].verAngle-e.result[0].verAngle;let t=[],a=[],r=[];for(let n=0;n<e.result.length;n++)e.result[n].longitude>0&&(t.push(e.result[n].longitude),a.push(e.result[n].latitude),r.push(e.result[n].altitude));t.sort((function(e,t){return e-t})),a.sort((function(e,t){return e-t})),r.sort((function(e,t){return e-t})),longitude=t[Math.floor(t.length/2)],latitude=a[Math.floor(t.length/2)],altitude=r[Math.floor(t.length/2)],position=Gps84ToGcj02(longitude,latitude);for(let t=0;t<e.result.length;t++)rdata.prr_A.push(e.result[t].prr_A),rdata.prr_B.push(e.result[t].prr_B),rdata.raw_A.push(e.result[t].raw_A),rdata.raw_B.push(e.result[t].raw_B),rdata.ext.push(e.result[t].ext),rdata.dep.push(e.result[t].dep),rdata.pm10.push(e.result[t].ext.map(e=>e>0?243*Math.pow(e,1.13):0)),rdata.pm25.push(e.result[t].ext.map(e=>e>0?121.5*Math.pow(e,1.13):0))}function Gps84ToGcj02(e,t){if(outOfChina(e,t))return new AMap.LngLat(e,t);let a=6378245,r=.006693421622965943,n=TransformLat(e-105,t-35),o=TransformLon(e-105,t-35),l=t/180*Math.PI,i=Math.sin(l);i=1-r*i*i;let s=Math.sqrt(i),d=t+(n=180*n/(a*(1-r)/(i*s)*Math.PI)),c=e+(o=180*o/(a/s*Math.cos(l)*Math.PI));return new AMap.LngLat(c,d)}function outOfChina(e,t){return e<72.004||e>137.8347||(t<.8293||t>55.8271)}function TransformLat(e,t){var a=2*e-100+3*t+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,a+=2*(160*Math.sin(t/12*Math.PI)+320*Math.sin(t*Math.PI/30))/3}function TransformLon(e,t){var a=300+e+2*t+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,a+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3}function SelectTime(){var e=document.getElementById("timeSeries"),t=e.selectedIndex;$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:e.options[t].text},url:urlGetRhiData,beforeSend:function(){document.getElementById("myLoading").style.display="block"},success:function(a){document.getElementById("myLoading").style.display="none",prepareData(a),SelectChannel(),horAng=a.result[0].horAngle,verAngStart=a.result[0].verAngle,verAngEnd=a.result[a.result.length-1].verAngle,verAngStep=a.result[1].verAngle-a.result[0].verAngle,document.getElementById("angleRange").textContent="扫描范围"+verAngStart+" - "+verAngEnd,document.getElementById("angleStep").textContent="扫描步长"+verAngStep,document.getElementById("angleHor").textContent="方位角"+horAng,document.getElementById("timeStamp").textContent=e.options[t].text+"至"+a.result[a.result.length-1].timestamp}})}function SelectChannel(){drawData=rdata.prr_A;var e=document.getElementById("channel");switch(e.options[e.selectedIndex].text){case"平行通道距离校正信号":drawData=rdata.prr_A;break;case"垂直通道距离校正信号":drawData=rdata.prr_B;break;case"消光系数":drawData=rdata.ext;break;case"退偏比":drawData=rdata.dep;break;case"平行通道原始信号":drawData=rdata.raw_A;break;case"垂直通道原始信号":drawData=rdata.raw_B;break;case"PM10":drawData=rdata.pm10;break;case"PM2.5":drawData=rdata.pm25}object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}function ChangeMaxValue(){var e=document.getElementById("colorMax");vMax=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),drawTickText()}function ChangeMinValue(){var e=document.getElementById("colorMin");vMin=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),drawTickText()}function ChangeRangeMax(){var e=document.getElementById("zMax");rangeMax=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}function ChangeColorOpacity(){var e=document.getElementById("opacity");colorOpacity=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}

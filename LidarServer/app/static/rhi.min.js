function drawColorbar(e){var t=document.getElementById("canvas");width=t.width,height=t.height;var a=t.getContext("2d"),r=a.createLinearGradient(0,10,0,250);for(let t=0;t<e;t++){var n=getColor(t/(e-1),0,1,1),o="rgb("+Math.floor(255*n.r)+","+Math.floor(255*n.g)+","+Math.floor(255*n.b)+")";r.addColorStop(1-t/(e-1),o)}a.fillStyle=r,a.fillRect(0,10,10,240)}var tickColor="black",textColor="black";function drawTicks(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(10,0,e.width,e.height),t.strokeStyle=tickColor;for(let e=0;e<6;e++)t.beginPath(),t.moveTo(10,10+48*e),t.lineTo(15,10+48*e),t.stroke()}function drawTickText(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(16,0,e.width,e.height);let a=(vMax-vMin)/5;t.fillStyle=textColor;for(let e=0;e<6;e++)t.fillText((vMax-e*a).toExponential(1),16,10+48*e)}drawColorbar(11),drawTicks();var vMax=1e4,vMin=0;drawTickText();var map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:16,pitch:60,center:[116.396132,39.900444]}),object3Dlayer=new AMap.Object3DLayer;map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var t=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(t),map.setLayers(t.getEnabledLayers()),t.on("layerPropChanged",(function(e){e.props.enable&&(e.layer.id.includes("satellite")?(tickColor="#FFF",textColor="#FFF",drawTicks(),drawTickText()):e.layer.id.includes("tile")&&(tickColor="#000",textColor="#000",drawTicks(),drawTickText()))}))})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)}));var rdata={},rangeMax=6e3,colorOpacity=(vMax=1e4,vMin=0,.5),resolution=15,horAng=0,verAngStart=0,verAngEnd=360,verAngStep=5,longitude=0,latitude=0,altitude=0,drawData=[],position=new AMap.LngLat(0,0);function createPie(e,t,a,r,n,o,l,i,s,d,c){for(var h=Math.floor((l-o)/i),p=0;p<h;p++){var u=generateTriangle(e,r,a,p,t,n,o+p*i,o+(p+1)*i,s,d,c);object3Dlayer.add(u)}}function generateTriangle(e,t,a,r,n,o,l,i,s,d,c){var h=map.lngLatToGeodeticCoord(e),p=(map.lngLatToGeodeticCoord(e.offset(5e3,0)).x-h.x)/5e3,u=h.x,g=h.y,M=[],v=[],m=[],x=[],y=[],A=[],w=t/a;a*=p;var f=l>90?o+180:o,C=i>90?o+180:o;l=l>90?180-l:l,i=i>90?180-i:i;for(var b=0;b<w+1;b++)M.push(u+b*a*Math.cos(l/180*Math.PI)*Math.sin(f/180*Math.PI)),v.push(g-b*a*Math.cos(l/180*Math.PI)*Math.cos(f/180*Math.PI)),m.push(0-b*a*Math.sin(l/180*Math.PI)),x.push(u+b*a*Math.cos(i/180*Math.PI)*Math.sin(C/180*Math.PI)),y.push(g-b*a*Math.cos(i/180*Math.PI)*Math.cos(C/180*Math.PI)),A.push(0-b*a*Math.sin(i/180*Math.PI));var I=new AMap.Object3D.Mesh;I.transparent=!0,I.backOrFront="both";var T=I.geometry;for(b=0;b<w;b++){T.vertices.push(M[b],v[b],m[b]),T.vertices.push(M[b+1],v[b+1],m[b+1]),T.vertices.push(x[b+1],y[b+1],A[b+1]),T.vertices.push(M[b],v[b],m[b]),T.vertices.push(x[b],y[b],A[b]),T.vertices.push(x[b+1],y[b+1],A[b+1]);var D=getColor(n[r][b],s,d,c),P=getColor(n[r][b+1],s,d,c),k=getColor(n[r+1][b],s,d,c),E=getColor(n[r+1][b+1],s,d,c);T.vertexColors.push(D.r,D.g,D.b,D.a),T.vertexColors.push(P.r,P.g,P.b,P.a),T.vertexColors.push(E.r,E.g,E.b,E.a),T.vertexColors.push(D.r,D.g,D.b,D.a),T.vertexColors.push(k.r,k.g,k.b,k.a),T.vertexColors.push(E.r,E.g,E.b,E.a)}return I}function getColor(e,t,a,r){var n={};e<t&&(e=t),e>a&&(e=a);var o=a-t;if(n.a=r-.1+.2*(e-t)/o,e<t+.25*o){var l=4*(e-t)/o;n.r=0,n.g=l,n.b=1}else if(e<t+.5*o){var i=1+4*(t+.25*o-e)/o;n.r=0,n.g=1,n.b=i}else if(e<t+.75*o){var s=4*(e-t-.5*o)/o;n.r=s,n.g=1,n.b=0}else{l=1+4*(t+.75*o-e)/o;n.r=1,n.g=l,n.b=0}return n}function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pm10=[],rdata.pm25=[],resolution=e.result[0].resolution,horAng=e.result[0].horAngle,verAngStart=e.result[0].verAngle,verAngEnd=e.result[e.result.length-1].verAngle,verAngStep=e.result[1].verAngle-e.result[0].verAngle;let t=[],a=[],r=[];for(let n=0;n<e.result.length;n++)e.result[n].longitude>0&&(t.push(e.result[n].longitude),a.push(e.result[n].latitude),r.push(e.result[n].altitude));t.sort((function(e,t){return e-t})),a.sort((function(e,t){return e-t})),r.sort((function(e,t){return e-t})),longitude=t[Math.floor(t.length/2)],latitude=a[Math.floor(t.length/2)],altitude=r[Math.floor(t.length/2)],position=Gps84ToGcj02(longitude,latitude);for(let t=0;t<e.result.length;t++)rdata.prr_A.push(e.result[t].prr_A),rdata.prr_B.push(e.result[t].prr_B),rdata.raw_A.push(e.result[t].raw_A),rdata.raw_B.push(e.result[t].raw_B),rdata.ext.push(e.result[t].ext),rdata.dep.push(e.result[t].dep),rdata.pm10.push(e.result[t].ext.map(e=>e>0?243*Math.pow(e,1.13):0)),rdata.pm25.push(e.result[t].ext.map(e=>e>0?121.5*Math.pow(e,1.13):0))}function Gps84ToGcj02(e,t){if(outOfChina(e,t))return new AMap.LngLat(e,t);let a=6378245,r=.006693421622965943,n=TransformLat(e-105,t-35),o=TransformLon(e-105,t-35),l=t/180*Math.PI,i=Math.sin(l);i=1-r*i*i;let s=Math.sqrt(i),d=t+(n=180*n/(a*(1-r)/(i*s)*Math.PI)),c=e+(o=180*o/(a/s*Math.cos(l)*Math.PI));return new AMap.LngLat(c,d)}function outOfChina(e,t){return e<72.004||e>137.8347||(t<.8293||t>55.8271)}function TransformLat(e,t){var a=2*e-100+3*t+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,a+=2*(160*Math.sin(t/12*Math.PI)+320*Math.sin(t*Math.PI/30))/3}function TransformLon(e,t){var a=300+e+2*t+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,a+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3}function SelectTime(){var e=document.getElementById("timeSeries"),t=e.selectedIndex;$.post(urlGetRhiData,{"task id":task_id,content:"timedata",time:e.options[t].text},(function(e,t){prepareData(e),SelectChannel()}))}function SelectChannel(){drawData=rdata.prr_A;var e=document.getElementById("channel");switch(e.options[e.selectedIndex].text){case"平行通道距离校正信号":drawData=rdata.prr_A;break;case"垂直通道距离校正信号":drawData=rdata.prr_B;break;case"消光系数":drawData=rdata.ext;break;case"退偏比":drawData=rdata.dep;break;case"平行通道原始信号":drawData=rdata.raw_A;break;case"垂直通道原始信号":drawData=rdata.raw_B;break;case"PM10":drawData=rdata.pm10;break;case"PM2.5":drawData=rdata.pm25}object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}function ChangeMaxValue(){var e=document.getElementById("colorMax");vMax=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),drawTickText()}function ChangeMinValue(){var e=document.getElementById("colorMin");vMin=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),drawTickText()}function ChangeRangeMax(){var e=document.getElementById("zMax");rangeMax=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}function ChangeColorOpacity(){var e=document.getElementById("opacity");colorOpacity=Number(e.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity)}$.post(urlGetRhiData,{"task id":task_id,content:"list"},(function(e,t){var a=document.getElementById("timeSeries");a.addEventListener("change",SelectTime),document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity);for(let t=0;t<e.result.length;t++)a.options.add(new Option(e.result[t].timestamp+""));$.post(urlGetRhiData,{"task id":task_id,content:"timedata",time:a.options[0].text},(function(e,t){prepareData(e),drawData=rdata.prr_A,createPie(position,drawData,resolution,rangeMax,horAng,verAngStart,verAngEnd,verAngStep,vMin,vMax,colorOpacity),map.setCenter(position),map.setFitView()}))}));

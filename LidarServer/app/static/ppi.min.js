function setMapCenter(){map.setCenter(position)}function saveMap(){html2canvas(document.getElementById("viewDiv")).then((function(e){e.toBlob((function(e){var t=document.createElement("a");if(void 0!==t.download){var a=URL.createObjectURL(e),n=document.getElementById("channel"),r=document.getElementById("timeSeries");t.setAttribute("href",a),t.setAttribute("download",n.options[n.selectedIndex].text+"_"+r.options[r.selectedIndex].text+".png"),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}))}))}function drawColorbar(e){var t=document.getElementById("canvas");width=t.width,height=t.height;var a=t.getContext("2d"),n=a.createLinearGradient(0,10,0,250);for(let t=0;t<e;t++){var r=getColor(t/(e-1),0,1,1),o="rgb("+Math.floor(255*r.r)+","+Math.floor(255*r.g)+","+Math.floor(255*r.b)+")";n.addColorStop(1-t/(e-1),o)}a.fillStyle=n,a.fillRect(0,10,10,240)}var tickColor="black",textColor="black";function drawTicks(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(10,0,e.width,e.height),t.strokeStyle=tickColor;for(let e=0;e<6;e++)t.beginPath(),t.moveTo(10,10+48*e),t.lineTo(15,10+48*e),t.stroke()}function drawTickText(){var e=document.getElementById("canvas"),t=e.getContext("2d");t.clearRect(16,0,e.width,e.height);let a=(vMax-vMin)/5;t.fillStyle=textColor;for(let e=0;e<6;e++)t.fillText((vMax-e*a).toExponential(1),16,10+48*e)}drawColorbar(11),drawTicks();var vMax=1e4,vMin=0;drawTickText();var geocoder,map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:16,pitch:0,center:[116.396132,39.900444]}),object3Dlayer=new AMap.Object3DLayer;map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var t=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite},{id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(t),map.setLayers(t.getEnabledLayers()),t.on("layerPropChanged",(function(e){e.props.enable&&(e.layer.id.includes("satellite")?(tickColor="#FFF",textColor="#FFF",drawTicks(),drawTickText()):e.layer.id.includes("tile")&&(tickColor="#000",textColor="#000",drawTicks(),drawTickText()))}))})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)}));var pie,rdata={},rangeMax=6e3,colorOpacity=.5,resolution=15,verAng=0,horAngStart=0,horAngEnd=360,horAngStep=5,longitude=0,latitude=0,altitude=0,drawData=[],position=new AMap.LngLat(0,0),is3D=!1,rotationAngle=0;function createPie(e,t,a,n,r,o,i,l,s,c,d){var p=Math.floor((i-o)/l);(pie=new AMap.Object3D.Mesh).transparent=!0,pie.backOrFront="both";for(var h=pie.geometry,g=0;g<p;g++)generateTriangle(h,e,n,a,g,t,r,o+g*l,o+(g+1)*l,s,c,d);pie.rotateZ(rotationAngle),pie.position(e),object3Dlayer.add(pie)}function generateTriangle(e,t,a,n,r,o,i,l,s,c,d,p){var h=[],g=[],u=[],m=[],M=[],v=[],y=a/n;n/=map.getResolution(t,20);for(var f=1e3/map.getResolution(t,20),A=0;A<y+1;A++){h.push(0+A*n*Math.cos(i/180*Math.PI)*Math.sin(l/180*Math.PI)),g.push(0-A*n*Math.cos(i/180*Math.PI)*Math.cos(l/180*Math.PI));var I=0-A*n*Math.sin(i/180*Math.PI);is3D&&(I=0,r<o.length&&(I=(o[r][A]-c)/(d-c)),I<0?I=0:I>3&&(I=1.5),I*=-f),u.push(I),m.push(0+A*n*Math.cos(i/180*Math.PI)*Math.sin(s/180*Math.PI)),M.push(0-A*n*Math.cos(i/180*Math.PI)*Math.cos(s/180*Math.PI));var x=0-A*n*Math.sin(i/180*Math.PI);is3D&&(x=0,r<o.length-1&&(x=(o[r+1][A]-c)/(d-c)),x<0?x=0:x>3&&(x=1.5),x*=-f),v.push(x)}for(A=0;A<y;A++)if(e.vertices.push(h[A],g[A],u[A]),e.vertices.push(h[A+1],g[A+1],u[A+1]),e.vertices.push(m[A+1],M[A+1],v[A+1]),e.vertices.push(h[A],g[A],u[A]),e.vertices.push(m[A],M[A],v[A]),e.vertices.push(m[A+1],M[A+1],v[A+1]),r<o.length-1){var w=getColor(o[r][A],c,d,p),C=getColor(o[r][A+1],c,d,p),P=getColor(o[r+1][A],c,d,p),D=getColor(o[r+1][A+1],c,d,p);e.vertexColors.push(w.r,w.g,w.b,w.a),e.vertexColors.push(C.r,C.g,C.b,C.a),e.vertexColors.push(D.r,D.g,D.b,D.a),e.vertexColors.push(w.r,w.g,w.b,w.a),e.vertexColors.push(P.r,P.g,P.b,P.a),e.vertexColors.push(D.r,D.g,D.b,D.a)}else e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0)}function getColor(e,t,a,n){var r={};e<t&&(e=t),e>a&&(e=a);var o=a-t;if(r.a=n-.1+.2*(e-t)/o,e<t+.25*o){var i=4*(e-t)/o;r.r=0,r.g=i,r.b=1}else if(e<t+.5*o){var l=1+4*(t+.25*o-e)/o;r.r=0,r.g=1,r.b=l}else if(e<t+.75*o){var s=4*(e-t-.5*o)/o;r.r=s,r.g=1,r.b=0}else{i=1+4*(t+.75*o-e)/o;r.r=1,r.g=i,r.b=0}return r}function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pm10=[],rdata.pm25=[];let t=[],a=[],n=[];for(let r=0;r<e.result.length;r++)e.result[r].longitude>0&&(t.push(e.result[r].longitude),a.push(e.result[r].latitude),n.push(e.result[r].altitude));t.sort((function(e,t){return e-t})),a.sort((function(e,t){return e-t})),n.sort((function(e,t){return e-t})),longitude=t[Math.floor(t.length/2)],latitude=a[Math.floor(t.length/2)],altitude=n[Math.floor(t.length/2)],position=Gps84ToGcj02(longitude,latitude);for(let t=0;t<e.result.length;t++)rdata.prr_A.push(e.result[t].prr_A),rdata.prr_B.push(e.result[t].prr_B),rdata.raw_A.push(e.result[t].raw_A),rdata.raw_B.push(e.result[t].raw_B),rdata.ext.push(e.result[t].ext),rdata.dep.push(e.result[t].dep),rdata.pm10.push(e.result[t].ext.map(e=>e>0?243*Math.pow(e,1.13):0)),rdata.pm25.push(e.result[t].ext.map(e=>e>0?121.5*Math.pow(e,1.13):0))}function addMapEvents(){document.getElementById("timeSeries").addEventListener("change",SelectTime),document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity),document.getElementById("rotation").addEventListener("change",ChangeRotationAngle),document.getElementById("createISOCurve").addEventListener("click",createISOHeatmap),document.getElementById("curvePlay").addEventListener("click",playHeatmap),document.getElementById("setCenter").addEventListener("click",setMapCenter),document.getElementById("addMarker").addEventListener("click",addMapMarker),document.getElementById("addRuler").addEventListener("click",addMapRuler),document.getElementById("addMeasurer").addEventListener("click",addMapMeasurer),document.getElementById("clearOverlay").addEventListener("click",clearMapOverlay),document.getElementById("savePic").addEventListener("click",saveMap)}$.post(urlGetPpiData,{"task id":task_id,content:"list"},(function(e,t){var a=document.getElementById("timeSeries");for(let t=0;t<e.result.length;t++)a.options.add(new Option(e.result[t].timestamp+""));$.post(urlGetPpiData,{"task id":task_id,content:"timedata",time:a.options[0].text},(function(e,t){resolution=e.result[0].resolution,verAng=e.result[0].verAngle,horAngStart=e.result[0].horAngle,horAngEnd=e.result[e.result.length-1].horAngle,horAngStep=e.result[1].horAngle-e.result[0].horAngle,prepareData(e),drawData=rdata.prr_A,createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),map.setCenter(position),map.setFitView(),document.getElementById("angleRange").textContent="扫描范围"+horAngStart+" - "+horAngEnd,document.getElementById("angleStep").textContent="扫描步长"+horAngStep,document.getElementById("angleVer").textContent="垂直角度"+verAng,document.getElementById("timeStamp").textContent=a.options[0].text+"至"+e.result[e.result.length-1].timestamp,addMapEvents()}))}));var mouseTool=new AMap.MouseTool(map),isPlaying=!1;function addMapMarker(){isPlaying||map.on("click",showInfoClick)}function showInfoClick(e){var t=e.lnglat,a=AMap.GeometryUtil.distance(t,position),n=Math.round(a/resolution/Math.cos(verAng/180*Math.PI)),r=map.lngLatToGeodeticCoord(position),o=map.lngLatToGeodeticCoord(t),i=(Math.atan2(o.y-r.y,o.x-r.x)/Math.PI*180+450)%360,l=i-horAngStart-rotationAngle;(l%=360)<0&&(l+=360);var s=Math.floor(l/horAngStep),c=new AMap.Marker({position:t});c.setMap(map),geocoder||(geocoder=new AMap.Geocoder({city:"010",radius:1e3})),geocoder.getAddress(t,(function(e,r){if("complete"===e&&r.regeocode){var o=r.regeocode.formattedAddress,l=document.getElementById("channel");c.setLabel({offset:new AMap.Pixel(0,-3),content:"<div><div>当前位置"+t.lng+","+t.lat+"</div><div class='info'>"+o+"</div><div class='info'>距离"+Math.round(a)+"</div><div class='info'>角度"+Math.round(i)+"</div><div class='info'>"+l.options[l.selectedIndex].text+"数值<b>"+drawData[s][n].toFixed(2)+"</b></div><div class='close-btn'>X</div></div>",direction:"top"}),c.on("click",deleteMarker)}else log.error("根据经纬度查询地址失败")}))}function clearMapOverlay(){map.off("click",showInfoClick),isPlaying||(mouseTool.close(!0),map.clearMap())}function addMapRuler(){map.off("click",showInfoClick),isPlaying||mouseTool.rule()}function addMapMeasurer(){map.off("click",showInfoClick),isPlaying||mouseTool.measureArea()}var overlays=[];function deleteMarker(e){map.remove(e.target)}function Gps84ToGcj02(e,t){if(outOfChina(e,t))return new AMap.LngLat(e,t);let a=6378245,n=.006693421622965943,r=TransformLat(e-105,t-35),o=TransformLon(e-105,t-35),i=t/180*Math.PI,l=Math.sin(i);l=1-n*l*l;let s=Math.sqrt(l),c=t+(r=180*r/(a*(1-n)/(l*s)*Math.PI)),d=e+(o=180*o/(a/s*Math.cos(i)*Math.PI));return new AMap.LngLat(d,c)}function outOfChina(e,t){return e<72.004||e>137.8347||(t<.8293||t>55.8271)}function TransformLat(e,t){var a=2*e-100+3*t+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,a+=2*(160*Math.sin(t/12*Math.PI)+320*Math.sin(t*Math.PI/30))/3}function TransformLon(e,t){var a=300+e+2*t+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return a+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,a+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,a+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3}function SelectTime(e){if(!isPlaying){var t=e.target,a=t.selectedIndex;$.post(urlGetPpiData,{"task id":task_id,content:"timedata",time:t.options[a].text},(function(e,n){prepareData(e),SelectChannel(),document.getElementById("timeStamp").textContent=t.options[a].text+"至"+e.result[e.result.length-1].timestamp}))}}mouseTool.on("draw",(function(e){e.obj}));var channelID="prr_A";function SelectChannel(){if(!isPlaying){var e=document.getElementById("channel");switch(drawData=rdata.prr_A,e.options[e.selectedIndex].text){case"平行通道距离校正信号":drawData=rdata.prr_A,channelID="prr_A";break;case"垂直通道距离校正信号":drawData=rdata.prr_B,channelID="prr_B";break;case"消光系数":drawData=rdata.ext,channelID="ext";break;case"退偏比":drawData=rdata.dep,channelID="dep";break;case"平行通道原始信号":drawData=rdata.raw_A,channelID="raw_A";break;case"垂直通道原始信号":drawData=rdata.raw_B,channelID="raw_B";break;case"PM10":drawData=rdata.pm10,channelID="pm10";break;case"PM2.5":drawData=rdata.pm25,channelID="pm25"}object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity)}}function ChangeMaxValue(e){if(!isPlaying){var t=e.target;vMax=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),drawTickText()}}function ChangeMinValue(e){if(!isPlaying){var t=e.target;vMin=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),drawTickText()}}function ChangeRangeMax(e){if(!isPlaying){var t=e.target;rangeMax=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity)}}function ChangeColorOpacity(e){if(!isPlaying){var t=e.target;colorOpacity=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity)}}function ChangeRotationAngle(e){if(!isPlaying){var t=e.target;rotationAngle=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity)}}function createISOHeatmap(e){if(!isPlaying){var t=e.target;is3D?(t.src="../static/3DHeatmap.png",t.title="3D热度图"):(t.src="../static/iso.png",t.title="2D热度图"),is3D=!is3D,object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity)}}var animData,canBeStop=!1;function playHeatmap(e){var t=e.target;isPlaying?canBeStop&&(isPlaying=!1,t.src="../static/play.svg",t.title="播放",document.getElementById("playSpeed").style.display="none"):(document.getElementById("playSpeed").style.display="block",getAnimationData())}function getAnimationData(){$.ajax({type:"post",data:{"task id":task_id,content:"all",channel:channelID},url:urlGetPpiData,beforeSend:function(){document.getElementById("curvePlay");isPlaying=!0,canBeStop=!1,document.getElementById("waitingPlay").style.display="block"},success:function(e){var t=document.getElementById("curvePlay");document.getElementById("waitingPlay").style.display="none",t.src="../static/stop.svg",t.title="停止",canBeStop=!0,animData=e,Scan()}})}var animI=0,playSpeed=1e3;async function Scan(){isPlaying&&(animI%=animData.result.length,drawData=animData.result[animI].channeldata,object3Dlayer.clear(),createPie(position,animData.result[animI].channeldata,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),document.getElementById("timeStamp").textContent=animData.result[animI].starttime+"至"+animData.result[animI].endtime,animI++,await sleep(playSpeed),AMap.Util.requestAnimFrame(Scan))}function sleep(e){return new Promise(t=>setTimeout(t,e))}function changePie(e){for(var t=Math.floor((horAngEnd-horAngStart)/horAngStep),a=pie.geometry,n=0;n<t;n++)changeTriangle(a,position,rangeMax,resolution,n,e,verAng,horAngStart+n*horAngStep,horAngStart+(n+1)*horAngStep,vMin,vMax,colorOpacity);pie.needUpdate=!0,pie.reDraw()}function changeTriangle(e,t,a,n,r,o,i,l,s,c,d,p){var h=[],g=[],u=[],m=[],M=[],v=[],y=a/n;n/=map.getResolution(t,20);for(var f=1e3/map.getResolution(t,20),A=0;A<y+1;A++){h.push(0+A*n*Math.cos(i/180*Math.PI)*Math.sin(l/180*Math.PI)),g.push(0-A*n*Math.cos(i/180*Math.PI)*Math.cos(l/180*Math.PI));var I=0-A*n*Math.sin(i/180*Math.PI);is3D&&((I=(o[r][A]-c)/(d-c))<0?I=0:I>3&&(I=1.5),I*=-f),u.push(I),m.push(0+A*n*Math.cos(i/180*Math.PI)*Math.sin(s/180*Math.PI)),M.push(0-A*n*Math.cos(i/180*Math.PI)*Math.cos(s/180*Math.PI));var x=0-A*n*Math.sin(i/180*Math.PI);is3D&&((x=(o[r+1][A]-c)/(d-c))<0?x=0:x>3&&(x=1.5),x*=-f),v.push(x)}for(A=0;A<y;A++)if(r<o.length-1)getColor(o[r][A],c,d,p),getColor(o[r][A+1],c,d,p),getColor(o[r+1][A],c,d,p),getColor(o[r+1][A+1],c,d,p)}document.getElementById("playSpeed").oninput=function(){playSpeed=100*this.value};

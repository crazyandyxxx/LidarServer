var map,geocoder,object3Dlayer,animData,lines,points3D,pie,mouseTool,drawName,positionLabel,vMax=1e4,vMin=0,animI=0,playSpeed=1e3,canBeStop=!1,rdata={},rangeMax=6e3,colorOpacity=.5,resolution=15,verAng=0,horAngStart=0,horAngEnd=360,horAngStep=5,longitude=0,latitude=0,altitude=0,drawData=[],timeat=[],height=[],position=new AMap.LngLat(0,0),is3D=!1,hoverAdd=!1,rotationAngle=0,isPlaying=!1,channelID="prr_A",layoutA={xaxis:{title:"时间",showline:!0,tickmode:"auto",range:[],showspikes:!0,spikemode:"across"},yaxis:{title:"距离(km)",showline:!0,range:[0,rangeMax/1e3]},paper_bgcolor:"transparent",plot_bgcolor:"transparent",margin:{t:30,l:60,b:57}},layoutLineA={xaxis:{title:"强度",showline:!0,tickmode:"auto",showexponent:"last",exponentformat:"power"},yaxis:{showline:!0,range:[0,rangeMax/1e3],ticks:"outside"},annotations:[{showarrow:!1,text:"",font:{color:"black"},xref:"paper",yref:"paper",x:.5,y:.5}],paper_bgcolor:"transparent",plot_bgcolor:"transparent",margin:{t:30,l:25,r:40,b:57}},layoutConfig={displayModeBar:!1,responsive:!0},PRA_data={},traceA={},lineIndex=0,plotA=document.getElementById("PRADiv"),rc=15e3,sa=40,snrT=2,pblT=.5,zoomLevel=13;function setMapCenter(){map.setZoomAndCenter(zoomLevel,position)}function saveMap(){html2canvas(document.getElementById("viewDiv")).then((function(e){e.toBlob((function(e){var t=document.createElement("a");if(void 0!==t.download){var a=URL.createObjectURL(e),n=document.getElementById("channel"),o=document.getElementById("timeSeries");t.setAttribute("href",a),t.setAttribute("download","水平扫描截图_"+n.options[n.selectedIndex].text+"_"+o.options[o.selectedIndex].text+".png"),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}))}))}function plotHover(e){var t="";for(let a=0;a<e.points.length;a++)"heatmap"===e.points[a].fullData.type&&(t=e.points[a].pointNumber);lineIndex=t[1];let a=rangeMax/map.getResolution(position,20),n=a*Math.sin(verAng/180*Math.PI),o=a*Math.cos(verAng/180*Math.PI)*Math.sin((horAngStart+lineIndex*horAngStep)/180*Math.PI),r=-a*Math.cos(verAng/180*Math.PI)*Math.cos((horAngStart+lineIndex*horAngStep)/180*Math.PI);lines.geometry.vertices.splice(3,2,o,r),lines.needUpdate=!0,points3D.geometry.vertices.splice(3,2,o,r),points3D.needUpdate=!0,lines.reDraw(),points3D.reDraw(),hoverAdd||(object3Dlayer.add(lines),object3Dlayer.add(points3D),hoverAdd=!0),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.react("lineADiv",[traceA],layoutLineA);let i=map.lngLatToGeodeticCoord(position),l=new AMap.Pixel(i.x+o,i.y+r),s=map.geodeticCoordToLngLat(l);positionLabel.setText((horAngStart+lineIndex*horAngStep).toString()),positionLabel.setHeight(n),positionLabel.setPosition(s),positionLabel.show()}function plotUnHover(e){object3Dlayer.remove(lines),object3Dlayer.remove(points3D),hoverAdd=!1,positionLabel.hide()}function createPieIndicator(){var e=(lines=new AMap.Object3D.Line).geometry;(points3D=new AMap.Object3D.RoundPoints).transparent=!0;var t=points3D.geometry;let a=rangeMax/map.getResolution(position,20),n=a*Math.sin(verAng/180*Math.PI),o=a*Math.cos(verAng/180*Math.PI)*Math.sin((horAngStart+lineIndex*horAngStep)/180*Math.PI),r=-a*Math.cos(verAng/180*Math.PI)*Math.cos((horAngStart+lineIndex*horAngStep)/180*Math.PI);e.vertices.push(0,0,0),e.vertexColors.push(0,1,1,1),e.vertices.push(o,r,-n),e.vertexColors.push(0,1,1,1),t.vertices.push(0,0,0),t.pointSizes.push(8),t.vertexColors.push(0,0,1,1),t.vertices.push(o,r,-n),t.pointSizes.push(16),t.vertexColors.push(.058,.03,.02,1),points3D.borderColor=[.4,.8,1,1],points3D.borderWeight=3,lines.rotateZ(rotationAngle),points3D.rotateZ(rotationAngle),lines.position(position),points3D.position(position)}function createPie(e,t,a,n,o,r,i,l,s,d,c){var p=Math.floor((i-r)/l);(pie=new AMap.Object3D.Mesh).transparent=!0,pie.backOrFront="both";for(var g=pie.geometry,u=0;u<p;u++)generateTriangle(g,e,n,a,u,t,o,r+u*l,r+(u+1)*l,s,d,c);pie.rotateZ(rotationAngle),pie.position(e),object3Dlayer.add(pie)}function generateTriangle(e,t,a,n,o,r,i,l,s,d,c,p){var g=[],u=[],m=[],h=[],y=[],v=[],A=a/n;n/=map.getResolution(t,20);var x=1e3/map.getResolution(t,20);for(let e=0;e<A+1;e++){g.push(0+e*n*Math.cos(i/180*Math.PI)*Math.sin(l/180*Math.PI)),u.push(0-e*n*Math.cos(i/180*Math.PI)*Math.cos(l/180*Math.PI));var M=0-e*n*Math.sin(i/180*Math.PI);is3D&&(M=0,o<r.length&&(M=(r[o][e]-d)/(c-d)),M<0?M=0:M>3&&(M=1.5),M*=-x),m.push(M),h.push(0+e*n*Math.cos(i/180*Math.PI)*Math.sin(s/180*Math.PI)),y.push(0-e*n*Math.cos(i/180*Math.PI)*Math.cos(s/180*Math.PI));var I=0-e*n*Math.sin(i/180*Math.PI);is3D&&(I=0,o<r.length-1&&(I=(r[o+1][e]-d)/(c-d)),I<0?I=0:I>3&&(I=1.5),I*=-x),v.push(I)}for(let t=0;t<A;t++)if(e.vertices.push(g[t],u[t],m[t]),e.vertices.push(g[t+1],u[t+1],m[t+1]),e.vertices.push(h[t+1],y[t+1],v[t+1]),e.vertices.push(g[t],u[t],m[t]),e.vertices.push(h[t],y[t],v[t]),e.vertices.push(h[t+1],y[t+1],v[t+1]),o<r.length-1){var D=getColor(r[o][t],d,c,p),w=getColor(r[o][t+1],d,c,p),f=getColor(r[o+1][t],d,c,p),P=getColor(r[o+1][t+1],d,c,p);e.vertexColors.push(D.r,D.g,D.b,D.a),e.vertexColors.push(w.r,w.g,w.b,w.a),e.vertexColors.push(P.r,P.g,P.b,P.a),e.vertexColors.push(D.r,D.g,D.b,D.a),e.vertexColors.push(f.r,f.g,f.b,f.a),e.vertexColors.push(P.r,P.g,P.b,P.a)}else e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0),e.vertexColors.push(0,0,0,0)}function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pm10=[],rdata.pm25=[],timeat=[],resolution=e.result[0].resolution,height=[],res=resolution/1e3;var t=e.result[0].raw_A.length;for(let e=0;e<t;e++)height.push((e+1)*res);verAng=e.result[0].verAngle,horAngStart=e.result[0].horAngle,horAngEnd=e.result[e.result.length-1].horAngle,horAngStep=e.result.length-1>0?e.result[1].horAngle-e.result[0].horAngle:0;let a=[],n=[],o=[];for(let t=0;t<e.result.length;t++)e.result[t].longitude>0&&(a.push(e.result[t].longitude),n.push(e.result[t].latitude),o.push(e.result[t].altitude));a.sort((function(e,t){return e-t})),n.sort((function(e,t){return e-t})),o.sort((function(e,t){return e-t})),longitude=a[Math.floor(a.length/2)],latitude=n[Math.floor(a.length/2)],altitude=o[Math.floor(a.length/2)],position=Gps84ToGcj02(longitude,latitude);for(let t=0;t<e.result.length;t++)timeat.push(e.result[t].timestamp),rdata.prr_A.push(e.result[t].prr_A),rdata.prr_B.push(e.result[t].prr_B),rdata.raw_A.push(e.result[t].raw_A),rdata.raw_B.push(e.result[t].raw_B),rdata.ext.push(e.result[t].ext),rdata.dep.push(e.result[t].dep),rdata.pm10.push(e.result[t].ext.map(e=>e>0?243*Math.pow(e,1.13):0)),rdata.pm25.push(e.result[t].ext.map(e=>e>0?121.5*Math.pow(e,1.13):0))}function addMapEvents(){document.getElementById("timeSeries").addEventListener("change",SelectTime),document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("zMin").addEventListener("change",ChangeRangeMin),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity),document.getElementById("rotation").addEventListener("change",ChangeRotationAngle),document.getElementById("createISOCurve").addEventListener("click",createISOHeatmap),document.getElementById("curvePlay").addEventListener("click",playHeatmap),document.getElementById("setCenter").addEventListener("click",setMapCenter),document.getElementById("addMarker").addEventListener("click",addMapMarker),document.getElementById("addRuler").addEventListener("click",addMapRuler),document.getElementById("addMeasurer").addEventListener("click",addMapMeasurer),document.getElementById("clearOverlay").addEventListener("click",clearMapOverlay),document.getElementById("saveMap").addEventListener("click",saveMap),document.getElementById("closeHeat").addEventListener("click",CloseHeatMap),document.getElementById("showHeat").addEventListener("click",ShowHeatMap),document.getElementById("savePicA").addEventListener("click",SaveHeatA),document.getElementById("saveLineA").addEventListener("click",SaveLineA),document.getElementById("realTime").addEventListener("click",getRealTimeData),document.getElementById("reCalc").addEventListener("click",ReCalculation),document.getElementById("showRecalc").addEventListener("click",ShowRecalc)}function addMapMarker(){isPlaying||map.on("click",showInfoClick)}function ShowRecalc(){isPlaying||$("#calcModal").modal("show")}function ReCalculation(){$("#calcModal").modal("hide"),rc=$("#rc").val(),sa=$("#sa").val(),snrT=$("#snrT").val(),pblT=$("#pblT").val();var e=document.getElementById("timeSeries"),t=e.selectedIndex;$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:e.options[t].text,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},url:urlGetPpiData,beforeSend:function(){$("#myLoading").modal("show")},success:function(e){$("#myLoading").modal("hide"),prepareData(e),SelectChannel()}})}function getRealTimeData(){document.getElementById("realTime").checked&&$.post(urlGetPpiData,{"task id":task_id,content:"list"},(function(e,t){if(isPlaying)setTimeout(getRealTimeData,1e4);else{$("timeSeries").empty();var a=document.getElementById("timeSeries");for(let t=0;t<e.result.length;t++)a.options.add(new Option(e.result[t].timestamp+""));a.selectedIndex=0,$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:a.options[0].text,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},url:urlGetPpiData,success:function(e){prepareData(e),lineIndex=0,plotA.removeListener("plotly_hover",plotHover);var t={"xaxis.range[0]":timeat[0],"xaxis.range[1]":timeat[timeat.length-1]};Plotly.relayout("PRADiv",t),SelectChannel(),plotA.on("plotly_hover",plotHover),document.getElementById("angleRange").textContent="扫描范围"+horAngStart+" - "+horAngEnd,document.getElementById("angleStep").textContent="扫描步长"+horAngStep,document.getElementById("angleVer").textContent="垂直角度"+verAng,document.getElementById("timeStamp").textContent=timeat[0]+"至"+timeat[timeat.length-1],setTimeout(getRealTimeData,1e4)}})}}))}function showInfoClick(e){var t=e.lnglat,a=AMap.GeometryUtil.distance(t,position),n=Math.round(a/resolution/Math.cos(verAng/180*Math.PI)),o=map.lngLatToGeodeticCoord(position),r=map.lngLatToGeodeticCoord(t),i=(Math.atan2(r.y-o.y,r.x-o.x)/Math.PI*180+450)%360,l=i-horAngStart-rotationAngle;(l%=360)<0&&(l+=360);var s=Math.floor(l/horAngStep),d=new AMap.Marker({position:t});d.setMap(map),geocoder||(geocoder=new AMap.Geocoder({city:"010",radius:1e3})),geocoder.getAddress(t,(function(e,o){if("complete"===e&&o.regeocode){var r=o.regeocode.formattedAddress,l=document.getElementById("channel");d.setLabel({offset:new AMap.Pixel(0,-3),content:"<div><div>当前位置"+t.lng+","+t.lat+"</div><div>"+r+"</div><div>距离"+Math.round(a)+"</div><div>角度"+Math.round(i)+"</div><div>"+l.options[l.selectedIndex].text+"数值<b>"+drawData[s][n].toFixed(2)+"</b></div><div class='close-btn'>X</div></div>",direction:"top"}),d.on("click",deleteMarker)}else log.error("根据经纬度查询地址失败")}))}function clearMapOverlay(){map.off("click",showInfoClick),isPlaying||(mouseTool.close(!0),map.clearMap())}function addMapRuler(){map.off("click",showInfoClick),isPlaying||mouseTool.rule()}function addMapMeasurer(){map.off("click",showInfoClick),isPlaying||mouseTool.measureArea()}function deleteMarker(e){map.remove(e.target)}function SelectTime(e){if(!isPlaying){var t=e.target,a=t.selectedIndex;$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:t.options[a].text,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},url:urlGetPpiData,beforeSend:function(){$("#myLoading").modal("show")},success:function(e){$("#myLoading").modal("hide"),prepareData(e),lineIndex=0,plotA.removeListener("plotly_hover",plotHover);var n={"xaxis.range[0]":timeat[0],"xaxis.range[1]":timeat[timeat.length-1]};Plotly.relayout("PRADiv",n),SelectChannel(),plotA.on("plotly_hover",plotHover),document.getElementById("angleRange").textContent="扫描范围"+horAngStart+" - "+horAngEnd,document.getElementById("angleStep").textContent="扫描步长"+horAngStep,document.getElementById("angleVer").textContent="垂直角度"+verAng,document.getElementById("timeStamp").textContent=t.options[a].text+"至"+e.result[e.result.length-1].timestamp}})}}function SelectChannel(){if(!isPlaying){var e=document.getElementById("channel");switch(drawData=rdata.prr_A,drawName=e.options[e.selectedIndex].text){case"平行通道距离校正信号":drawData=rdata.prr_A,channelID="prr_A";break;case"垂直通道距离校正信号":drawData=rdata.prr_B,channelID="prr_B";break;case"消光系数":drawData=rdata.ext,channelID="ext";break;case"退偏比":drawData=rdata.dep,channelID="dep";break;case"平行通道原始信号":drawData=rdata.raw_A,channelID="raw_A";break;case"垂直通道原始信号":drawData=rdata.raw_B,channelID="raw_B";break;case"PM10":drawData=rdata.pm10,channelID="pm10";break;case"PM2.5":drawData=rdata.pm25,channelID="pm25"}object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator(),PRA_data.x=timeat,PRA_data.z=drawData,traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("PRADiv",[PRA_data],layoutA),Plotly.react("lineADiv",[traceA],layoutLineA)}}function ChangeMaxValue(e){if(!isPlaying){var t=e.target;vMax=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator(),drawTickText();var a={zmax:vMax};Plotly.restyle("PRADiv",a)}}function ChangeMinValue(e){if(!isPlaying){var t=e.target;vMin=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator(),drawTickText();var a={zmin:vMin};Plotly.restyle("PRADiv",a)}}function ChangeRangeMax(e){if(!isPlaying){var t=e.target;rangeMax=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator(),layoutA.yaxis.range[1]=rangeMax/1e3,layoutLineA.yaxis.range[1]=rangeMax/1e3;var a={"yaxis.range[1]":rangeMax/1e3};Plotly.relayout("PRADiv",a),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA),circle.setRadius(rangeMax*Math.cos(verAng/180*Math.PI))}}function ChangeRangeMin(){var e=document.getElementById("zMin");rangeMin=Number(e.value),layoutA.yaxis.range[0]=rangeMin/1e3,layoutLineA.yaxis.range[0]=rangeMin/1e3;var t={"yaxis.range[0]":rangeMin/1e3};Plotly.relayout("PRADiv",t),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeColorOpacity(e){if(!isPlaying){var t=e.target;colorOpacity=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator()}}function ChangeRotationAngle(e){if(!isPlaying){var t=e.target;rotationAngle=Number(t.value),object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator()}}function createISOHeatmap(e){if(!isPlaying){var t=e.target;is3D?(t.src="../static/3DHeatmap.png",t.title="3D热度图"):(t.src="../static/iso.png",t.title="2D热度图"),is3D=!is3D,object3Dlayer.clear(),createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator()}}function playHeatmap(e){var t=e.target;isPlaying?canBeStop&&(isPlaying=!1,t.src="../static/play.svg",t.title="播放",document.getElementById("playSpeed").style.display="none"):(document.getElementById("playSpeed").style.display="block",getAnimationData())}function getAnimationData(){$.ajax({type:"post",data:{"task id":task_id,content:"all",channel:channelID,range:rangeMax,"calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},url:urlGetPpiData,beforeSend:function(){isPlaying=!0,canBeStop=!1,$("#myLoading").modal("show")},success:function(e){var t=document.getElementById("curvePlay");$("#myLoading").modal("hide"),t.src="../static/stop.svg",t.title="停止",canBeStop=!0,animData=e,Scan()}})}async function Scan(){isPlaying&&(animI%=animData.result.length,horAngStart=animData.result[animI].horStartAng,horAngEnd=animData.result[animI].horEndAng,horAngStep=animData.result[animI].horAngStep,object3Dlayer.clear(),createPie(position,animData.result[animI].channeldata,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),document.getElementById("timeStamp").textContent=animData.result[animI].starttime+"至"+animData.result[animI].endtime,document.getElementById("angleRange").textContent="扫描范围"+horAngStart+" - "+horAngEnd,animI++,await sleep(playSpeed),AMap.Util.requestAnimFrame(Scan))}function sleep(e){return new Promise(t=>setTimeout(t,e))}function SaveHeatA(){Plotly.downloadImage("PRADiv",{format:"png",width:1e3,height:500,filename:"水平扫描_"+drawName+"从"+timeat[0]+"至"+timeat[timeat.length-1]})}function SaveLineA(){let e="";e+="Data Length,"+drawData[lineIndex].length+"\r\n",e+="Resolution,"+resolution+"\r\n",e+=drawData[lineIndex].join(",")+"\r\n";var t=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(t,"水平扫描_"+drawName+timeat[lineIndex]+".csv");else{var a=document.createElement("a");if(void 0!==a.download){var n=URL.createObjectURL(t);a.setAttribute("href",n),a.setAttribute("download","水平扫描_"+drawName+"_"+timeat[lineIndex]+".csv"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}}window.onload=function(){drawColorbar(11),drawTicks(),drawTickText(),map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:zoomLevel,pitch:0,center:[116.396132,39.900444]}),positionLabel=new AMap.Text({map:map}),$((function(){$('[data-toggle="tooltip"]').tooltip()})),object3Dlayer=new AMap.Object3DLayer,map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var t=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite},{id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(t),map.setLayers(t.getEnabledLayers()),t.on("layerPropChanged",(function(e){e.props.enable&&(e.layer.id.includes("satellite")?(tickColor="#FFF",textColor="#FFF",drawTicks(),drawTickText()):e.layer.id.includes("tile")&&(tickColor="#000",textColor="#000",drawTicks(),drawTickText()))}))})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)})),$.post(urlGetPpiData,{"task id":task_id,content:"list"},(function(e,t){var a=document.getElementById("timeSeries");for(let t=0;t<e.result.length;t++)a.options.add(new Option(e.result[t].timestamp+""));$.ajax({type:"post",data:{"task id":task_id,content:"timedata",time:a.options[0].text},url:urlGetPpiData,beforeSend:function(){$("#myLoading").modal("show")},success:function(e){$("#myLoading").modal("hide"),addMapEvents(),prepareData(e),drawData=rdata.prr_A,createPie(position,drawData,resolution,rangeMax,verAng,horAngStart,horAngEnd,horAngStep,vMin,vMax,colorOpacity),createPieIndicator(),map.setZoomAndCenter(zoomLevel,position),PRA_data={z:drawData,x:timeat,y:height,zmin:vMin,zmax:vMax,type:"heatmap",transpose:!0,colorscale:createColorScale(11),colorbar:{thickness:15,xpad:5,showexponent:"last",exponentformat:"power"}},traceA={x:drawData[0].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),y:height,mode:"lines",line:{color:"black",width:2}},layoutA.xaxis.range=[timeat[0],timeat[timeat.length-1]],layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.newPlot("PRADiv",[PRA_data],layoutA,layoutConfig),Plotly.newPlot("lineADiv",[traceA],layoutLineA,layoutConfig),plotA.on("plotly_hover",plotHover),plotA.on("plotly_unhover",plotUnHover),document.getElementById("angleRange").textContent="扫描范围"+horAngStart+" - "+horAngEnd,document.getElementById("angleStep").textContent="扫描步长"+horAngStep,document.getElementById("angleVer").textContent="垂直角度"+verAng,document.getElementById("timeStamp").textContent=timeat[0]+"至"+timeat[timeat.length-1]}})})),(mouseTool=new AMap.MouseTool(map)).on("draw",(function(e){e.obj})),document.getElementById("playSpeed").oninput=function(){playSpeed=100*this.value}};

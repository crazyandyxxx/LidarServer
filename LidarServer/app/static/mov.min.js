var map,object3Dlayer;function createRectangle(e,a,t,r,n,o,l,i,s,c,d){var p=map.lngLatToGeodeticCoord(e),u=map.lngLatToGeodeticCoord(a),g=[],y=[],h=[],x=[],v=[],m=[],M=Math.floor(n/t),A=Math.floor(r/t);t*=o;for(var b=A;b<M+1;b++)g.push(p.x),y.push(p.y),h.push(0-b*t),x.push(u.x),v.push(u.y),m.push(0-b*t);var w=new AMap.Object3D.Mesh;w.transparent=!0,w.backOrFront="both";var D=w.geometry;for(b=0;b<M-A;b++){D.vertices.push(g[b],y[b],h[b]),D.vertices.push(g[b+1],y[b+1],h[b+1]),D.vertices.push(x[b+1],v[b+1],m[b+1]),D.vertices.push(g[b],y[b],h[b]),D.vertices.push(x[b],v[b],m[b]),D.vertices.push(x[b+1],v[b+1],m[b+1]);var f=getColor(i[l][b+A],s,c,d),L=getColor(i[l][b+1+A],s,c,d),I=getColor(i[l+1][b+A],s,c,d),C=getColor(i[l+1][b+1+A],s,c,d);D.vertexColors.push(f.r,f.g,f.b,f.a),D.vertexColors.push(L.r,L.g,L.b,L.a),D.vertexColors.push(C.r,C.g,C.b,C.a),D.vertexColors.push(f.r,f.g,f.b,f.a),D.vertexColors.push(I.r,I.g,I.b,I.a),D.vertexColors.push(C.r,C.g,C.b,C.a)}return w}function createWall(e,a,t,r,n,o,l,i,s){var c=e.length-1,d=map.lngLatToGeodeticCoord(e[0]),p=map.lngLatToGeodeticCoord(e[0].offset(5e3,0));t*=scal=(p.x-d.x)/5e3,n*=scal,r*=scal;for(let d=0;d<c;d++){var u=createRectangle(e[d],e[d+1],t,r,n,o,d,a,l,i,s);object3Dlayer.add(u)}}function getColor(e,a,t,r){var n={};e<a&&(e=a),e>t&&(e=t);var o=t-a;if(n.a=r-.1+.2*(e-a)/o,e<a+.25*o){var l=4*(e-a)/o;n.r=0,n.g=l,n.b=1}else if(e<a+.5*o){var i=1+4*(a+.25*o-e)/o;n.r=0,n.g=1,n.b=i}else if(e<a+.75*o){var s=4*(e-a-.5*o)/o;n.r=s,n.g=1,n.b=0}else{l=1+4*(a+.75*o-e)/o;n.r=1,n.g=l,n.b=0}return n}function createColorScale(e){var a=[];for(let n=0;n<e;n++){var t=getColor(n/(e-1),0,1,1),r="rgb("+Math.floor(255*t.r)+","+Math.floor(255*t.g)+","+Math.floor(255*t.b)+")";a.push([n/(e-1),r])}return a}window.onload=function(){map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:14,pitch:60,center:[116.396132,39.900444]}),object3Dlayer=new AMap.Object3DLayer,map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var a=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite},{id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(a),map.setLayers(a.getEnabledLayers())})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)})),map.on("mousemove",(function(e){var a=e.pixel,t=new AMap.Pixel(a.x,a.y),r=map.getObject3DByContainerPos(t,[object3Dlayer],!1)||{};null!=points3D&&(points3D.geometry.vertexColors.splice(4,4,.058,.03,.02,1),r.object==points3D&&points3D.geometry.vertexColors.splice(4,4,0,1,0,1),points3D.needUpdate=!0,points3D.reDraw())})),map.on("click",(function(e){var a=e.pixel,t=new AMap.Pixel(a.x,a.y);(map.getObject3DByContainerPos(t,[object3Dlayer],!1)||{}).object==points3D&&poistionLabel.show()})),$.post(urlGetMovData,{"task id":task_id,content:"view"},(function(e,a){document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("zMin").addEventListener("change",ChangeRangeMin),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity),document.getElementById("scale").addEventListener("change",ChangeRangeScale),prepareData(e),drawData=rdata.prr_A,createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),map.setCenter(locations[0]),map.setFitView(),createWallIndicator(),PRA_data={z:drawData,x:timeat,y:height,zmin:0,zmax:1e4,type:"heatmap",transpose:!0,colorscale:createColorScale(11),colorbar:{thickness:15,xpad:5,showexponent:"last",exponentformat:"power"}},traceA={x:drawData[0].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),y:height,mode:"lines",line:{color:"black",width:2}},tracePbl={x:timeat,y:rdata.pbl,mode:"markers",type:"scatter",marker:{color:"black"},showlegend:!1,visible:!1},layoutA.xaxis.range=[timeat[0],timeat[timeat.length-1]],layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.newPlot("PRADiv",[PRA_data,tracePbl],layoutA,layoutConfig),Plotly.newPlot("lineADiv",[traceA],layoutLineA,layoutConfig),plotA.on("plotly_hover",plotHover),poistionLabel=new AMap.Text({position:locations[lineIndex],height:rangeMax*scal*rangeScale,map:map}),setPositionLabel()}))};var lines,points3D,poistionLabel,rdata={},rangeMax=3e3,rangeMin=0,vMax=1e4,vMin=0,colorOpacity=.5,rangeScale=1,scal=1,resolution=15,locations=[],drawData=[],timeat=[],height=[],drawName="平行通道距离校正信号",layoutA={xaxis:{title:"时间",showline:!0,tickmode:"auto",range:[],showspikes:!0,spikemode:"across"},yaxis:{title:"距离(km)",showline:!0,range:[0,3]}},layoutLineA={xaxis:{title:"强度",showline:!0,tickmode:"auto",showexponent:"last",exponentformat:"power"},yaxis:{showline:!0,range:[0,3],ticks:"outside"},annotations:[{showarrow:!1,text:"",font:{color:"black"},xref:"paper",yref:"paper",x:.5,y:.5}]},layoutConfig={displayModeBar:!1,responsive:!0},PRA_data={},traceA={},tracePbl={};function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pbl=[],rdata.pm10=[],rdata.pm25=[],resolution=e.result[0].resolution;var a=e.result[0].raw_A.length;for(let e=0;e<a;e++)height.push((e+1)*resolution/1e3);for(let a=0;a<e.result.length;a++)if(e.result[a].longitude>-180){timeat.push(e.result[a].timestamp),rdata.prr_A.push(e.result[a].prr_A),rdata.prr_B.push(e.result[a].prr_B),rdata.raw_A.push(e.result[a].raw_A),rdata.raw_B.push(e.result[a].raw_B),rdata.ext.push(e.result[a].ext),rdata.dep.push(e.result[a].dep),rdata.pbl.push(e.result[a].pbl/1e3),rdata.pm10.push(e.result[a].ext.map(e=>e>0?243*Math.pow(e,1.13):0)),rdata.pm25.push(e.result[a].ext.map(e=>e>0?121.5*Math.pow(e,1.13):0));var t=e.result[a].longitude,r=e.result[a].latitude;e.result[a].altitude;locations.push(Gps84ToGcj02(t,r))}}function createWallIndicator(){var e=map.lngLatToGeodeticCoord(locations[lineIndex]),a=(lines=new AMap.Object3D.Line).geometry;(points3D=new AMap.Object3D.RoundPoints).transparent=!0;var t=points3D.geometry,r=scal*rangeMax*rangeScale;a.vertices.push(e.x,e.y,0),a.vertexColors.push(0,1,1,1),a.vertices.push(e.x,e.y,-r),a.vertexColors.push(0,1,1,1),t.vertices.push(e.x,e.y,0),t.pointSizes.push(8),t.vertexColors.push(0,0,1,1),t.vertices.push(e.x,e.y,-r),t.pointSizes.push(20),t.vertexColors.push(.058,.03,.02,1),points3D.borderColor=[.4,.8,1,1],points3D.borderWeight=3,object3Dlayer.add(lines),object3Dlayer.add(points3D)}var geocoder,lineIndex=0,plotA=document.getElementById("PRADiv");function plotHover(e){var a="";for(let t=0;t<e.points.length;t++)"heatmap"===e.points[t].fullData.type&&(a=e.points[t].pointNumber);lineIndex=a[1];var t=map.lngLatToGeodeticCoord(locations[lineIndex]),r=scal*rangeMax*rangeScale;lines.geometry.vertices.splice(0,6,t.x,t.y,0,t.x,t.y,-r),lines.needUpdate=!0,points3D.geometry.vertices.splice(0,6,t.x,t.y,0,t.x,t.y,-r),points3D.needUpdate=!0,lines.reDraw(),points3D.reDraw(),setPositionLabel(),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.react("lineADiv",[traceA],layoutLineA)}function setPositionLabel(){var e=(AMap.GeometryUtil.distanceOfLine(locations.slice(0,lineIndex))/1e3).toFixed(1);geocoder||(geocoder=new AMap.Geocoder({city:"010",radius:1e3})),geocoder.getAddress(locations[lineIndex],(function(a,t){if("complete"===a&&t.regeocode){var r=t.regeocode.formattedAddress;poistionLabel.setPosition(locations[lineIndex]),poistionLabel.setLabel({offset:new AMap.Pixel(10,0),content:"<div><div>当前位置"+locations[lineIndex].lng+","+locations[lineIndex].lat+"</div><div class='info'>"+r+"</div><div>距起点"+e+"km</div><div class='close-btn' onclick='hideMarker()'>X</div></div>",direction:"right"})}else log.error("根据经纬度查询地址失败")}))}function hideMarker(){poistionLabel.hide()}function Gps84ToGcj02(e,a){if(outOfChina(e,a))return new AMap.LngLat(e,a);let t=6378245,r=.006693421622965943,n=TransformLat(e-105,a-35),o=TransformLon(e-105,a-35),l=a/180*Math.PI,i=Math.sin(l);i=1-r*i*i;let s=Math.sqrt(i),c=a+(n=180*n/(t*(1-r)/(i*s)*Math.PI)),d=e+(o=180*o/(t/s*Math.cos(l)*Math.PI));return new AMap.LngLat(d,c)}function outOfChina(e,a){return e<72.004||e>137.8347||(a<.8293||a>55.8271)}function TransformLat(e,a){var t=2*e-100+3*a+.2*a*a+.1*e*a+.2*Math.sqrt(Math.abs(e));return t+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,t+=2*(20*Math.sin(a*Math.PI)+40*Math.sin(a/3*Math.PI))/3,t+=2*(160*Math.sin(a/12*Math.PI)+320*Math.sin(a*Math.PI/30))/3}function TransformLon(e,a){var t=300+e+2*a+.1*e*e+.1*e*a+.1*Math.sqrt(Math.abs(e));return t+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,t+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,t+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3}function SelectChannel(){var e=document.getElementById("channel");switch(drawName=e.options[e.selectedIndex].text,tracePbl.visible=!1,drawName){case"平行通道距离校正信号":drawData=rdata.prr_A;break;case"垂直通道距离校正信号":drawData=rdata.prr_B;break;case"消光系数":drawData=rdata.ext;break;case"退偏比":drawData=rdata.dep;break;case"平行通道原始信号":drawData=rdata.raw_A;break;case"垂直通道原始信号":drawData=rdata.raw_B;break;case"PM10":drawData=rdata.pm10;break;case"PM2.5":drawData=rdata.pm25;break;case"污染边界层":tracePbl.visible=!0}object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),PRA_data.z=drawData,traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("PRADiv",[PRA_data,tracePbl],layoutA),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeMaxValue(){var e=document.getElementById("colorMax");vMax=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator();var a={zmax:vMax};Plotly.restyle("PRADiv",a)}function ChangeMinValue(){var e=document.getElementById("colorMin");vMin=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator();var a={zmin:vMin};Plotly.restyle("PRADiv",a)}function ChangeRangeMax(){var e=document.getElementById("zMax");rangeMax=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),poistionLabel.setHeight(rangeMax*scal*rangeScale),layoutA.yaxis.range[1]=rangeMax/1e3,layoutLineA.yaxis.range[1]=rangeMax/1e3;var a={"yaxis.range[1]":rangeMax/1e3};Plotly.relayout("PRADiv",a),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeRangeMin(){var e=document.getElementById("zMin");rangeMin=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),layoutA.yaxis.range[0]=rangeMin/1e3,layoutLineA.yaxis.range[0]=rangeMin/1e3;var a={"yaxis.range[0]":rangeMin/1e3};Plotly.relayout("PRADiv",a),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeColorOpacity(){var e=document.getElementById("opacity");colorOpacity=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator()}function ChangeRangeScale(){var e=document.getElementById("scale");rangeScale=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),poistionLabel.setHeight(rangeMax*scal*rangeScale)}function SaveHeatA(){Plotly.downloadImage("PRADiv",{format:"png",width:1e3,height:500,filename:drawName+"从"+timeat[0]+"至"+timeat[timeat.length-1]})}function SaveLineA(){let e="";e+="Data Length,"+drawData[lineIndex].length+"\r\n",e+="Resolution,"+resolution+"\r\n",e+=drawData[lineIndex].join(",")+"\r\n";var a=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,drawNameA+timeat[lineIndex]+".csv");else{var t=document.createElement("a");if(void 0!==t.download){var r=URL.createObjectURL(a);t.setAttribute("href",r),t.setAttribute("download",drawName+"_"+timeat[lineIndex]+".csv"),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}}

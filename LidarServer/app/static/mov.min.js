var map,object3Dlayer,locCenter,lines,points3D,channelID,poistionLabel,geocoder,disProvince,polyline,rdata={},rangeMax=3e3,rangeMin=0,vMax=1e4,vMin=0,colorOpacity=.5,rangeScale=1,scal=1,resolution=15,locations=[],drawData=[],timeat=[],height=[],drawName=document.getElementById("channel").options[0].text,layoutA={xaxis:{title:"时间",showline:!0,tickmode:"auto",range:[],showspikes:!0,spikemode:"across"},yaxis:{title:"距离(km)",showline:!0,range:[0,3]},paper_bgcolor:"transparent",plot_bgcolor:"transparent",margin:{t:30,l:60,b:57}},layoutLineA={xaxis:{title:"强度",showline:!0,tickmode:"auto",showexponent:"last",exponentformat:"power"},yaxis:{showline:!0,range:[0,3],ticks:"outside"},annotations:[{showarrow:!1,text:"",font:{color:"black"},xref:"paper",yref:"paper",x:.5,y:.5}],paper_bgcolor:"transparent",plot_bgcolor:"transparent",margin:{t:30,l:20,r:40,b:57}},layoutConfig={displayModeBar:!1,responsive:!0},PRA_data={},traceA={},tracePbl={},lineIndex=0,plotA=document.getElementById("PRADiv"),colors={},rc=15e3,sa=40,snrT=2,pblT=.5,pa=243,pb=1.13,pc=.5;function setMapCenter(){map.setFitView([polyline])}function ShowRecalc(){$("#calcModal").modal("show")}function ReCalculation(){$("#calcModal").modal("hide"),rc=$("#rc").val(),sa=$("#sa").val(),snrT=$("#snrT").val(),pblT=$("#pblT").val(),pa=$("#pa").val(),pb=$("#pb").val(),pc=$("#pc").val(),$.ajax({type:"post",data:{"task id":task_id,content:"view","calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},url:urlGetMovData,beforeSend:function(){$("#myLoading").modal("show")},success:function(e){$("#myLoading").modal("hide"),prepareData(e),SelectChannel()}})}function saveMap(){html2canvas(document.getElementById("viewDiv")).then((function(e){e.toBlob((function(e){var a=document.createElement("a");if(void 0!==a.download){var t=URL.createObjectURL(e);a.setAttribute("href",t),a.setAttribute("download","走航扫描截图_"+drawName+timeat[0]+"-"+timeat[timeat.length-1]+".png"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}))}))}function addEvents(){document.getElementById("channel").addEventListener("change",SelectChannel),document.getElementById("colorMax").addEventListener("change",ChangeMaxValue),document.getElementById("colorMin").addEventListener("change",ChangeMinValue),document.getElementById("zMax").addEventListener("change",ChangeRangeMax),document.getElementById("zMin").addEventListener("change",ChangeRangeMin),document.getElementById("opacity").addEventListener("change",ChangeColorOpacity),document.getElementById("scale").addEventListener("change",ChangeRangeScale),document.getElementById("realTime").addEventListener("click",getRealTimeData),document.getElementById("reCalc").addEventListener("click",ReCalculation),document.getElementById("saveMap").addEventListener("click",saveMap),document.getElementById("showRecalc").addEventListener("click",ShowRecalc),document.getElementById("closeHeat").addEventListener("click",CloseHeatMap),document.getElementById("showHeat").addEventListener("click",ShowHeatMap),document.getElementById("savePicA").addEventListener("click",SaveHeatA),document.getElementById("saveLineA").addEventListener("click",SaveLineA),document.getElementById("setCenter").addEventListener("click",setMapCenter)}function createRectangle(e,a,t,n,o,r,l,i,c,s,d){var p=map.lngLatToGeodeticCoord(e),u=map.lngLatToGeodeticCoord(a),g=[],y=[],m=[],v=[],x=[],h=[],b=Math.floor(o/t),w=Math.floor(n/t);t*=r;for(let e=w;e<b+1;e++)g.push(p.x),y.push(p.y),m.push(0-e*t),v.push(u.x),x.push(u.y),h.push(0-e*t);var A=new AMap.Object3D.Mesh;A.transparent=!0,A.backOrFront="both";var M=A.geometry;for(let e=0;e<b-w;e++){M.vertices.push(g[e],y[e],m[e]),M.vertices.push(g[e+1],y[e+1],m[e+1]),M.vertices.push(v[e+1],x[e+1],h[e+1]),M.vertices.push(g[e],y[e],m[e]),M.vertices.push(v[e],x[e],h[e]),M.vertices.push(v[e+1],x[e+1],h[e+1]);var D=getColor(i[l][e+w],c,s,d),L=getColor(i[l][e+1+w],c,s,d),f=getColor(i[l+1][e+w],c,s,d),C=getColor(i[l+1][e+1+w],c,s,d);M.vertexColors.push(D.r,D.g,D.b,D.a),M.vertexColors.push(L.r,L.g,L.b,L.a),M.vertexColors.push(C.r,C.g,C.b,C.a),M.vertexColors.push(D.r,D.g,D.b,D.a),M.vertexColors.push(f.r,f.g,f.b,f.a),M.vertexColors.push(C.r,C.g,C.b,C.a)}return A}function createWall(e,a,t,n,o,r,l,i,c){var s=e.length-1;t*=scal=1/map.getResolution(locCenter,20),o*=scal,n*=scal;for(let p=0;p<s;p++){var d=createRectangle(e[p],e[p+1],t,n,o,r,p,a,l,i,c);object3Dlayer.add(d)}}function getRealTimeData(){document.getElementById("realTime").checked&&$.post(urlGetMovData,{"task id":task_id,content:"view","calc param":`{"rc": ${rc}, "sa": ${sa}, "snrT": ${snrT}, "pblT": ${pblT} }`},(function(e,a){if("success"==a){if(prepareData(e),showHeat){lineIndex=timeat.length-1,layoutLineA.annotations[0].text=timeat[lineIndex],plotA.removeListener("plotly_hover",plotHover);var t={"xaxis.range[0]":timeat[0],"xaxis.range[1]":timeat[timeat.length-1]};Plotly.relayout("PRADiv",t),tracePbl.x=timeat}SelectChannel(),setPositionLabel(),polyline.setPath(locations),map.setFitView([polyline]),showHeat&&plotA.on("plotly_hover",plotHover),setTimeout(getRealTimeData,1e4)}}))}function prepareData(e){rdata.raw_A=[],rdata.raw_B=[],rdata.prr_A=[],rdata.prr_B=[],rdata.ext=[],rdata.dep=[],rdata.pbl=[],rdata.aod=[],rdata.pm10=[],rdata.pm25=[],timeat=[],locations=[],height=[],res=e.result[0].resolution/1e3;var a=e.result[0].raw_A.length;for(let e=0;e<a;e++)height.push((e+1)*res);let t=0,n=0;for(let a=0;a<e.result.length;a++)if(e.result[a].longitude>-180){timeat.push(e.result[a].timestamp),rdata.prr_A.push(e.result[a].prr_A),rdata.prr_B.push(e.result[a].prr_B),rdata.raw_A.push(e.result[a].raw_A),rdata.raw_B.push(e.result[a].raw_B),rdata.ext.push(e.result[a].ext),rdata.dep.push(e.result[a].dep),rdata.pbl.push(e.result[a].pbl/1e3);let l=e.result[a].ext.slice(0,Math.round(3/res)).reduce((e,a)=>e+a)*res;rdata.aod.push(l>15?15:l),rdata.pm10.push(e.result[a].ext.map(e=>e>0?pa*Math.pow(e,pb):0)),rdata.pm25.push(e.result[a].ext.map(e=>e>0?pc*pa*Math.pow(e,pb):0));var o=e.result[a].longitude,r=e.result[a].latitude;e.result[a].altitude;t+=o,n+=r,locations.push(Gps84ToGcj02(o,r))}t/=e.result.length,n/=e.result.length,locCenter=Gps84ToGcj02(t,n)}function createWallIndicator(){var e=map.lngLatToGeodeticCoord(locations[lineIndex]),a=(lines=new AMap.Object3D.Line).geometry;(points3D=new AMap.Object3D.RoundPoints).transparent=!0;var t=points3D.geometry,n=scal*rangeMax*rangeScale;a.vertices.push(e.x,e.y,0),a.vertexColors.push(0,1,1,1),a.vertices.push(e.x,e.y,-n),a.vertexColors.push(0,1,1,1),t.vertices.push(e.x,e.y,0),t.pointSizes.push(8),t.vertexColors.push(0,0,1,1),t.vertices.push(e.x,e.y,-n),t.pointSizes.push(20),t.vertexColors.push(.058,.03,.02,1),points3D.borderColor=[.4,.8,1,1],points3D.borderWeight=3,object3Dlayer.add(lines),object3Dlayer.add(points3D)}function plotHover(e){var a="";for(let t=0;t<e.points.length;t++)"heatmap"===e.points[t].fullData.type&&(a=e.points[t].pointNumber);lineIndex=a[1];var t=map.lngLatToGeodeticCoord(locations[lineIndex]),n=scal*rangeMax*rangeScale;lines.geometry.vertices.splice(0,6,t.x,t.y,0,t.x,t.y,-n),lines.needUpdate=!0,points3D.geometry.vertices.splice(0,6,t.x,t.y,0,t.x,t.y,-n),points3D.needUpdate=!0,lines.reDraw(),points3D.reDraw(),setPositionLabel(),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.react("lineADiv",[traceA],layoutLineA)}function setPositionLabel(){var e=(AMap.GeometryUtil.distanceOfLine(locations.slice(0,lineIndex))/1e3).toFixed(1);geocoder||(geocoder=new AMap.Geocoder({city:"010",radius:1e3})),geocoder.getAddress(locations[lineIndex],(function(a,t){if("complete"===a&&t.regeocode){var n=t.regeocode.formattedAddress;poistionLabel.setPosition(locations[lineIndex]),poistionLabel.setLabel({offset:new AMap.Pixel(10,0),content:"<div><div>当前位置"+locations[lineIndex].lng+","+locations[lineIndex].lat+"</div><div>"+n+"</div><div>距起点"+e+"km</div><div class='close-btn' onclick='hideMarker()'>X</div></div>",direction:"right"})}else log.error("根据经纬度查询地址失败")}))}function hideMarker(){poistionLabel.hide()}function createBound(){geocoder||(geocoder=new AMap.Geocoder({city:"010",radius:1e3})),geocoder.getAddress(locCenter,(function(e,a){if("complete"===e&&a.regeocode){var t=a.regeocode.addressComponent.adcode;initPro(t=parseInt(t.substr(0,2)+"0000"),1)}else log.error("根据经纬度查询所在省份失败")}))}function initPro(e,a){a=void 0===a?2:a,adCode=e,depth=a,disProvince&&disProvince.setMap(null),(disProvince=new AMap.DistrictLayer.Province({zIndex:12,adcode:[e],depth:a,styles:{fill:function(e){var a=e.adcode;return getColorByAdcode(a)},"province-stroke":"brown","city-stroke":"white","county-stroke":"rgba(255,255,255,0.5)"}})).setMap(map)}window.onload=function(){drawColorbar(11),drawTicks(),drawTickText(),map=new AMap.Map("viewDiv",{viewMode:"3D",expandZoomRange:!0,zooms:[3,20],zoom:14,pitch:60,center:[116.396132,39.900444]}),object3Dlayer=new AMap.Object3DLayer,map.add(object3Dlayer),AMapUI.loadUI(["control/BasicControl"],(function(e){var a=new e.LayerSwitcher({position:"rt",baseLayers:[{enable:!0,id:"Atile",name:"高德矢量图",layer:new AMap.TileLayer},{id:"Asatellite",name:"高德卫星图",layer:new AMap.TileLayer.Satellite},{id:"Gtile",name:"谷歌矢量图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=m@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})},{id:"Gsatellite",name:"谷歌卫星图",layer:new AMap.TileLayer({getTileUrl:"http://mt{1,2,3,0}.google.cn/vt/lyrs=y@126&hl=zh-CN&gl=cn&src=app&s=G&x=[x]&y=[y]&z=[z]",zIndex:2})}],overlayLayers:[{id:"roadNet",name:"高德路网图",layer:new AMap.TileLayer.RoadNet},{enable:!0,id:"object3D",name:"雷达扫描图",layer:object3Dlayer}]});map.addControl(a),map.setLayers(a.getEnabledLayers()),a.on("layerPropChanged",(function(e){e.props.enable&&(e.layer.id.includes("satellite")?(tickColor="#FFF",textColor="#FFF",drawTicks(),drawTickText()):e.layer.id.includes("tile")&&(tickColor="#000",textColor="#000",drawTicks(),drawTickText()))}))})),AMap.plugin(["AMap.ControlBar","AMap.Scale"],(function(){map.addControl(new AMap.ControlBar({position:{left:"-90px"}})),map.addControl(new AMap.Scale)})),map.on("mousemove",(function(e){var a=e.pixel,t=new AMap.Pixel(a.x,a.y),n=map.getObject3DByContainerPos(t,[object3Dlayer],!1)||{};null!=points3D&&(points3D.geometry.vertexColors.splice(4,4,.058,.03,.02,1),n.object==points3D&&points3D.geometry.vertexColors.splice(4,4,0,1,0,1),points3D.needUpdate=!0,points3D.reDraw())})),map.on("click",(function(e){var a=e.pixel,t=new AMap.Pixel(a.x,a.y);(map.getObject3DByContainerPos(t,[object3Dlayer],!1)||{}).object==points3D&&poistionLabel.show()})),$((function(){$('[data-toggle="tooltip"]').tooltip()})),(polyline=new AMap.Polyline({strokeColor:"#3366FF",strokeOpacity:1,strokeWeight:8,strokeStyle:"solid",lineJoin:"round",lineCap:"round",zIndex:50})).setMap(map),$.ajax({type:"post",data:{"task id":task_id,content:"view"},url:urlGetMovData,beforeSend:function(){$("#myLoading").modal("show")},success:function(e){$("#myLoading").modal("hide"),addEvents(),prepareData(e),drawData=rdata.prr_A,createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createBound(),createWallIndicator(),polyline.setPath(locations),map.setFitView([polyline]),PRA_data={z:drawData,x:timeat,y:height,zmin:vMin,zmax:vMax,type:"heatmap",transpose:!0,colorscale:createColorScale(11),colorbar:{thickness:15,xpad:5,showexponent:"last",exponentformat:"power"}},traceA={x:drawData[0].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),y:height,mode:"lines",line:{color:"black",width:2}},tracePbl={x:timeat,y:rdata.pbl,mode:"markers",type:"scatter",marker:{color:"black"},showlegend:!1,visible:!1},layoutA.xaxis.range=[timeat[0],timeat[timeat.length-1]],layoutLineA.annotations[0].text=timeat[lineIndex],Plotly.newPlot("PRADiv",[PRA_data,tracePbl],layoutA,layoutConfig),Plotly.newPlot("lineADiv",[traceA],layoutLineA,layoutConfig),plotA.on("plotly_hover",plotHover),poistionLabel=new AMap.Text({position:locations[lineIndex],height:rangeMax*scal*rangeScale,map:map}),setPositionLabel()}})};var getColorByAdcode=function(e){if(!colors[e]){var a=155*Math.random()+50;colors[e]="rgba("+a+","+a+",160,0.3)"}return colors[e]};function SelectChannel(){var e=document.getElementById("channel");switch(channelID=e.options[e.selectedIndex].value,drawName=e.options[e.selectedIndex].text,tracePbl.visible=!1,channelID){case"prr_A":drawData=rdata.prr_A;break;case"prr_B":drawData=rdata.prr_B;break;case"ext":drawData=rdata.ext;break;case"dep":drawData=rdata.dep;break;case"raw_A":drawData=rdata.raw_A;break;case"raw_B":drawData=rdata.raw_B;break;case"pm10":drawData=rdata.pm10;break;case"pm25":drawData=rdata.pm25;break;case"pbl":drawData=rdata.ext,tracePbl.y=rdata.pbl,tracePbl.visible=!0;break;case"aod":drawData=rdata.ext,tracePbl.y=rdata.aod,tracePbl.visible=!0}object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),PRA_data.x=timeat,PRA_data.z=drawData,traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("PRADiv",[PRA_data,tracePbl],layoutA),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeMaxValue(){var e=document.getElementById("colorMax");vMax=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator();var a={zmax:vMax};Plotly.restyle("PRADiv",a),drawTickText()}function ChangeMinValue(){var e=document.getElementById("colorMin");vMin=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator();var a={zmin:vMin};Plotly.restyle("PRADiv",a),drawTickText()}function ChangeRangeMax(){var e=document.getElementById("zMax");rangeMax=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),poistionLabel.setHeight(rangeMax*scal*rangeScale),layoutA.yaxis.range[1]=rangeMax/1e3,layoutLineA.yaxis.range[1]=rangeMax/1e3;var a={"yaxis.range[1]":rangeMax/1e3};Plotly.relayout("PRADiv",a),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeRangeMin(){var e=document.getElementById("zMin");rangeMin=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),layoutA.yaxis.range[0]=rangeMin/1e3,layoutLineA.yaxis.range[0]=rangeMin/1e3;var a={"yaxis.range[0]":rangeMin/1e3};Plotly.relayout("PRADiv",a),traceA.x=drawData[lineIndex].slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),traceA.y=height.slice(layoutLineA.yaxis.range[0]/resolution*1e3,layoutLineA.yaxis.range[1]/resolution*1e3),Plotly.react("lineADiv",[traceA],layoutLineA)}function ChangeColorOpacity(){var e=document.getElementById("opacity");colorOpacity=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator()}function ChangeRangeScale(){var e=document.getElementById("scale");rangeScale=Number(e.value),object3Dlayer.clear(),createWall(locations,drawData,resolution,rangeMin,rangeMax,rangeScale,vMin,vMax,colorOpacity),createWallIndicator(),poistionLabel.setHeight(rangeMax*scal*rangeScale)}function SaveHeatA(){Plotly.downloadImage("PRADiv",{format:"png",width:1e3,height:500,filename:"走航扫描_"+drawName+"从"+timeat[0]+"至"+timeat[timeat.length-1]})}function SaveLineA(){let e="";e+="Data Length,"+drawData[lineIndex].length+"\r\n",e+="Resolution,"+resolution+"\r\n",e+=drawData[lineIndex].join(",")+"\r\n";var a=new Blob([e],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(a,"走航扫描_"+drawName+timeat[lineIndex]+".csv");else{var t=document.createElement("a");if(void 0!==t.download){var n=URL.createObjectURL(a);t.setAttribute("href",n),t.setAttribute("download","走航扫描_"+drawName+"_"+timeat[lineIndex]+".csv"),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}}
